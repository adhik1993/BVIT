<!DOCTYPE html>
<script>
// Global Firebase Offline Fallback (must be first)
(function() {
    if (typeof window.firebase === 'undefined') {
        window.firebaseOfflineMode = false;
        window.firebase = {
            database: function() {
                window.firebaseOfflineMode = true;
                return {
                    ref: function() { return { on: function() {}, once: function() {}, off: function() {}, set: function() {}, update: function() {}, remove: function() {} }; }
                };
            },
            auth: function() {
                window.firebaseOfflineMode = true;
                return {
                    onAuthStateChanged: function(cb) { cb(null); return function(){}; },
                    signOut: function() { return Promise.resolve(); },
                    currentUser: null
                };
            },
            apps: [],
        };
    }
})();
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BVIT</title>
    
    <!-- Load Firebase SDKs first -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Then load our Firebase config -->
    <script src="firebase-config.js"></script>
    
    <!-- Other resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --dark: #1F2937;
            --darker: #111827;
            --light: #F3F4F6;
            --lighter: #F9FAFB;
            --border: #E5E7EB;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --text-lighter: #9CA3AF;
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--light);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--darker);
            min-height: 100vh;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: var(--text-lighter);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link i {
            font-size: 1.25rem;
            width: 1.5rem;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .stat-students { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .stat-teachers { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .stat-attendance { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-performance { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Recent Activity Styles */
        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 0;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 2rem;
        }

        .activity-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .activity-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        .activity-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-header h3 i {
            font-size: 1.5rem;
        }

        .activity-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--primary-light);
            color: var(--primary);
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .activity-details {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .activity-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
            background: var(--light);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
        }

        .activity-detail i {
            font-size: 0.875rem;
            color: var(--primary);
        }

        .activity-time {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .action-title {
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 5rem;
                padding: 1rem;
            }

            .logo-text, .nav-text {
                display: none;
            }

            .main-content {
                margin-left: 5rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 1rem;
            }
        }

        /* Add logout button styles */
        .logout-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px; /* Added for better touch targets */
        }

        .logout-button:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .logout-button i {
            font-size: 1.2rem;
        }

        /* Update sidebar padding to accommodate logout button */
        .sidebar {
            padding-bottom: 100px;
        }

        /* Mobile styles for logout button */
        @media (max-width: 1024px) {
    .sidebar .logout-button {
        position: absolute;
        left: 20px;
        bottom: 40px;
        width: 48px;
        height: 48px;
        padding: 0;
        border-radius: 50%;
        justify-content: center;
        align-items: center;
        min-width: unset;
        min-height: unset;
    }
    .sidebar .logout-button span {
        display: none;
    }
    .sidebar .logout-button i {
        font-size: 1.3rem;
        margin: 0;
    }
    .header-logout { display: none !important; }
}
        @media (min-width: 1025px) {
            .header-logout { display: none !important; }
        }
        /* Ensure sidebar is scrollable and on top */
        .sidebar {
            overflow-y: auto;
            z-index: 9999;
        }

        /* Remove charts related styles */
        .charts-grid,
        .chart-container,
        .chart-header,
        .chart-title,
        .chart-actions {
            display: none;
        }

        /* Update grid layouts */
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .quick-actions {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        /* Make cards bigger */
        .stat-card {
            padding: 2rem;
        }

        .action-card {
            padding: 2rem;
        }

        .stat-icon {
            width: 4rem;
            height: 4rem;
            font-size: 2rem;
        }

        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .action-title {
            font-size: 1.2rem;
        }

        /* Update activity card */
        .activity-card {
            margin-top: 2rem;
        }

        .activity-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .activity-list {
            padding: 1rem;
        }

        .activity-item {
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-graduation-cap logo-icon"></i>
            <span class="logo-text">BVIT Admin</span>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="student-management.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Students</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="teacher-management.html" class="nav-link">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span class="nav-text">Teachers</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="clerk-management.html" class="nav-link">
                    <i class="fas fa-user-tie"></i>
                    <span class="nav-text">Clerks</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="view-reports.html" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-text">Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showFeedbackReport()">
                    <i class="fas fa-comment-dots"></i>
                    <span class="nav-text">Feedback Report</span>
                </a>
            </li>

            <li class="nav-section">
                <span class="nav-section-title">Settings</span>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </li>
        </ul>
        <button class="logout-button" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="header">
                <h1 class="page-title">Dashboard Overview</h1>
                <div class="header-actions">
                    <button class="logout-button header-logout" onclick="handleLogout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon stat-students">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-value" id="totalStudents">Loading...</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-teachers">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-value" id="totalTeachers">Loading...</div>
                <div class="stat-label">Total Teachers</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-attendance">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stat-value" id="averageAttendance">Loading...</div>
                <div class="stat-label">Average Attendance</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-performance">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value" id="performanceRate">Loading...</div>
                <div class="stat-label">Performance Rate</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-card" onclick="window.location.href='student-management.html'">
                <i class="fas fa-user-plus action-icon"></i>
                <div class="action-title">Add Student</div>
            </div>
            <div class="action-card" onclick="window.location.href='teacher-management.html'">
                <i class="fas fa-user-tie action-icon"></i>
                <div class="action-title">Add Teacher</div>
            </div>
            <div class="action-card" onclick="window.location.href='view-reports.html'">
                <i class="fas fa-file-alt action-icon"></i>
                <div class="action-title">View Reports</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Attendance Trend</h3>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Department Statistics</h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>
        </div>

        <!-- Feedback Report Section -->
        <div id="feedbackReportSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-comment-dots"></i> Feedback Report
                    <span id="feedbackStatusIndicator" style="font-size: 0.8rem; margin-left: 1rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">Loading...</span>
                </h1>
                <div class="header-actions">
                    <button id="feedbackToggleBtn" class="btn" onclick="toggleFeedbackSystem()" style="margin-right: 1rem;">
                        <i class="fas fa-toggle-on"></i> <span id="feedbackToggleText">Disable Feedback</span>
                    </button>
                    <button class="btn btn-primary" onclick="showDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Feedback Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(79, 70, 229, 0.1); color: var(--primary);">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <div class="stat-value" id="totalFeedbacks">0</div>
                    <div class="stat-label">Total Feedbacks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--secondary);">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-value" id="averageRating">0.0</div>
                    <div class="stat-label">Average Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="stat-value" id="topRatedTeacher">-</div>
                    <div class="stat-label">Top Rated Teacher</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-value" id="thisMonthFeedbacks">0</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <!-- Feedback Filters -->
            <div class="feedback-filters" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department:</label>
                        <select id="departmentFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Class/Year:</label>
                        <select id="classFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Teacher:</label>
                        <select id="teacherFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Teachers</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subject:</label>
                        <select id="subjectFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Subjects</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Lecture Type:</label>
                        <select id="lectureTypeFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Types</option>
                            <option value="Theory">Theory</option>
                            <option value="Practical">Practical</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rating:</label>
                        <select id="ratingFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Ratings</option>
                            <option value="5">5 Stars</option>
                            <option value="4">4+ Stars</option>
                            <option value="3">3+ Stars</option>
                            <option value="2">2+ Stars</option>
                            <option value="1">1+ Stars</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Feedback Table -->
            <div class="feedback-table-container" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-table"></i> Feedback Details
                    </h3>
                </div>
                <div style="overflow-x: auto;">
                    <table id="feedbackTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Student</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Department</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Class</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Teacher</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Subject</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Type</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Rating</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Action</th>
                            </tr>
                        </thead>
                        <tbody id="feedbackTableBody">
                            <tr>
                                <td colspan="9" style="padding: 2rem; text-align: center; color: var(--text-light);">
                                    <i class="fas fa-spinner fa-spin"></i> Loading feedback data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        console.log('Firebase services ready');

        // Function to update dashboard stats
        async function updateDashboardStats() {
            try {
                // Wait for Firebase initialization from firebase-config.js
                if (typeof window.waitForFirebase === 'function') {
                    await window.waitForFirebase();
                }
                console.log('Fetching dashboard stats...');
                
                // Get total students count
                const studentsSnapshot = await window.db.ref('students').once('value');
                const totalStudents = studentsSnapshot.exists() ? Object.keys(studentsSnapshot.val()).length : 0;
                document.getElementById('totalStudents').textContent = totalStudents;
                
                // Get total teachers count
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                const totalTeachers = teachersSnapshot.exists() ? Object.keys(teachersSnapshot.val()).length : 0;
                document.getElementById('totalTeachers').textContent = totalTeachers;
                
                // Calculate average attendance
                const attendanceSnapshot = await window.db.ref('attendance').once('value');
                let totalAttendance = 0;
                let attendanceCount = 0;
                
                if (attendanceSnapshot.exists()) {
                    attendanceSnapshot.forEach(dateSnapshot => {
                        const students = dateSnapshot.val().students || {};
                        const presentCount = Object.values(students).filter(status => status === true).length;
                        const totalCount = Object.keys(students).length;
                        if (totalCount > 0) {
                            totalAttendance += (presentCount / totalCount) * 100;
                            attendanceCount++;
                        }
                    });
                }
                
                const averageAttendance = attendanceCount > 0 ? (totalAttendance / attendanceCount).toFixed(1) : 0;
                document.getElementById('averageAttendance').textContent = averageAttendance + '%';
                
                // Calculate performance rate (based on attendance for now)
                const performanceRate = averageAttendance > 0 ? averageAttendance : 0;
                document.getElementById('performanceRate').textContent = performanceRate + '%';
                
                console.log('Dashboard stats updated:', {
                    totalStudents,
                    totalTeachers,
                    averageAttendance,
                    performanceRate
                });
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Function to update recent activities
        async function updateRecentActivities() {
            try {
                await waitForFirebase();
                const activityList = document.getElementById('activityList');
                
                // Check if element exists
                if (!activityList) {
                    console.warn('activityList element not found, skipping recent activities update');
                    return;
                }
                
                // Get recent attendance records from Firebase
                const attendanceSnapshot = await window.db.ref('attendance')
                    .orderByChild('timestamp')
                    .limitToLast(10)
                    .once('value');
                
                // Clear loading state
                activityList.innerHTML = '';
                
                if (attendanceSnapshot.exists()) {
                    // Convert to array and sort by timestamp
                    const activities = [];
                    attendanceSnapshot.forEach(snap => {
                        const data = snap.val();
                        if (data.teacherId) {
                        activities.push({
                                id: snap.key,
                                ...data,
                                timestamp: data.timestamp || Date.now()
                        });
                        }
                    });
                    
                    // Sort by timestamp descending
                    activities.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Get teacher details
                    const teacherIds = [...new Set(activities.map(a => a.teacherId))];
                    const teacherDetails = {};
                    
                    for (const teacherId of teacherIds) {
                        const teacherSnap = await window.db.ref('teachers/' + teacherId).once('value');
                        if (teacherSnap.exists()) {
                            const teacher = teacherSnap.val();
                            teacherDetails[teacherId] = `${teacher.firstName} ${teacher.lastName}`;
                        }
                    }
                    
                    // Add activities to the list
                    activities.slice(0, 10).forEach(activity => {
                        const timeAgo = getTimeAgo(activity.timestamp);
                        const teacherName = teacherDetails[activity.teacherId] || 'Unknown Teacher';
                        
                        const li = document.createElement('li');
                        li.className = 'activity-item';
                        li.innerHTML = `
                            <div class="activity-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">
                                    ${teacherName} took attendance
                                </div>
                                <div class="activity-details">
                                    <span class="activity-detail">
                                        <i class="fas fa-users"></i>
                                        ${activity.class || 'N/A'}
                                    </span>
                                    <span class="activity-detail">
                                        <i class="fas fa-book"></i>
                                        ${activity.subject || 'N/A'}
                                    </span>
                                    <span class="activity-detail">
                                        <i class="fas fa-clock"></i>
                                        ${activity.lectureType || 'N/A'}
                                    </span>
                                </div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        `;
                        activityList.appendChild(li);
                    });
                } else {
                    // Show no activities message
                    activityList.innerHTML = `
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">No attendance records found</div>
                            </div>
                        </li>
                    `;
                }
            } catch (error) {
                console.error('Error updating recent activities:', error);
                // Show error message only if element exists
                const activityList = document.getElementById('activityList');
                if (activityList) {
                    activityList.innerHTML = `
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Error loading attendance records</div>
                            </div>
                        </li>
                    `;
                }
            }
        }

        // Helper function to get time ago
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        // Helper function to get activity icon
        function getActivityIcon(type) {
            switch (type) {
                case 'attendance':
                    return 'fa-clipboard-check';
                case 'student':
                    return 'fa-user-graduate';
                case 'teacher':
                    return 'fa-chalkboard-teacher';
                case 'report':
                    return 'fa-file-alt';
                default:
                    return 'fa-bell';
            }
        }

        // Update stats and activities when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Update stats and activities
                updateDashboardStats();
                updateRecentActivities();
                
                // Initialize charts
                const attendanceChart = document.getElementById('attendanceChart');
                const departmentChart = document.getElementById('departmentChart');

                if (attendanceChart && departmentChart) {
                    try {
                        // Get attendance data for last 6 months
                        const attendanceData = await getAttendanceData();
                        
                        // Get department data
                        const departmentData = await getDepartmentData();
                        
                        // Attendance Trend Chart
                        new Chart(attendanceChart, {
                            type: 'line',
                            data: {
                                labels: attendanceData.labels,
                                datasets: [{
                                    label: 'Attendance Rate',
                                    data: attendanceData.values,
                                    borderColor: '#4F46E5',
                                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100
                                    }
                                }
                            }
                        });

                        // Department Chart
                        new Chart(departmentChart, {
                            type: 'bar',
                            data: {
                                labels: departmentData.labels,
                                datasets: [{
                                    label: 'Students',
                                    data: departmentData.values,
                                    backgroundColor: [
                                        'rgba(79, 70, 229, 0.7)',
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(245, 158, 11, 0.7)',
                                        'rgba(239, 68, 68, 0.7)',
                                        'rgba(59, 130, 246, 0.7)'
                                    ],
                                    borderRadius: 8
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error initializing charts:', error);
                    }
                }
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });

        // Function to get attendance data for last 6 months
        async function getAttendanceData() {
            try {
                await waitForFirebase();
                const months = [];
                const values = [];
                const today = new Date();
                
                // Get last 6 months
                for (let i = 5; i >= 0; i--) {
                    const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    months.push(month.toLocaleString('default', { month: 'short' }));
                }
                
                // Get attendance data for each month
                const attendanceSnapshot = await window.db.ref('attendance').once('value');
                const attendanceData = attendanceSnapshot.val() || {};
                
                // Calculate monthly averages
                months.forEach(month => {
                    let totalAttendance = 0;
                    let count = 0;
                    
                    Object.entries(attendanceData).forEach(([date, data]) => {
                        const attendanceDate = new Date(date);
                        if (attendanceDate.toLocaleString('default', { month: 'short' }) === month) {
                            const students = data.students || {};
                            const presentCount = Object.values(students).filter(status => status === true).length;
                            const totalCount = Object.keys(students).length;
                            if (totalCount > 0) {
                                totalAttendance += (presentCount / totalCount) * 100;
                                count++;
                            }
                        }
                    });
                    
                    values.push(count > 0 ? (totalAttendance / count).toFixed(1) : 0);
                });
                
                return { labels: months, values };
                
            } catch (error) {
                console.error('Error getting attendance data:', error);
                return { labels: [], values: [] };
            }
        }

        // Function to get department-wise student count
        async function getDepartmentData() {
            try {
                await waitForFirebase();
                const departments = {
                    'Computer': 'CT',
                    'IT': 'IT',
                    'Mechanical': 'ME',
                    'Civil': 'CE',
                    'E&TC': 'ET'
                };
                
                const studentsSnapshot = await window.db.ref('students').once('value');
                const students = studentsSnapshot.val() || {};
                
                const departmentCounts = {};
                Object.values(students).forEach(student => {
                    const dept = student.department;
                    departmentCounts[dept] = (departmentCounts[dept] || 0) + 1;
                });
                
                const labels = Object.keys(departments);
                const values = labels.map(dept => departmentCounts[departments[dept]] || 0);
                
                return { labels, values };
                
            } catch (error) {
                console.error('Error getting department data:', error);
                return { labels: [], values: [] };
            }
        }

        // Handle logout
        function handleLogout() {
            console.log('Logging out...');
            
            // Clear session storage
            sessionStorage.clear();
            console.log('Session storage cleared');
            
            // Sign out from Firebase
            firebase.auth().signOut()
                .then(() => {
                    console.log('Firebase sign out successful');
                    window.location.href = 'welcome.html';
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                    // Still redirect to login page
                    window.location.href = 'welcome.html';
                });
        }

        // Debounce function to limit activity listener calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to check if admin is authenticated
        function isAdminAuthenticated() {
                const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn');
                const adminData = sessionStorage.getItem('adminData');
            const adminToken = localStorage.getItem('adminToken');
                
            console.log('Checking admin authentication:', {
                isAdminLoggedIn,
                hasAdminData: !!adminData,
                hasAdminToken: !!adminToken
            });
                
            return isAdminLoggedIn === 'true' && (adminData || adminToken);
        }

        // Function to navigate with session check
        function navigateWithSessionCheck(url) {
            console.log('Navigating to:', url);
            
            if (isAdminAuthenticated()) {
                // Reset auto logout timer if exists
                if (typeof startAutoLogoutTimer === 'function') {
                    startAutoLogoutTimer('admin');
                }
                // Force re-set session for admin
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                if (!sessionStorage.getItem('adminData') && window.adminData) {
                    sessionStorage.setItem('adminData', JSON.stringify(window.adminData));
                }
                // Store current URL before navigation
                sessionStorage.setItem('lastPage', window.location.href);
                window.location.href = url;
            } else {
                console.log('Not authenticated, redirecting to welcome');
                sessionStorage.clear();
                localStorage.removeItem('adminToken');
                window.location.href = 'welcome.html';
            }
        }

        // Update navigation when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up navigation');
            
            // Check initial authentication
            if (!isAdminAuthenticated()) {
                console.log('Initial auth check failed');
                window.location.href = 'welcome.html';
                return;
            }
            
            // Update navigation links with debounced click handler
            const debouncedNavigate = debounce((url) => {
                navigateWithSessionCheck(url);
            }, 300);
            
            document.querySelectorAll('.nav-link, .action-card').forEach(element => {
                const href = element.getAttribute('href') || 
                            element.getAttribute('onclick')?.match(/window\.location\.href='([^']+)'/)?.[1];
                
                if (href && href !== '#') {
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Navigation clicked:', href);
                        debouncedNavigate(href);
                    });
                    
                    // Remove onclick attribute to prevent double navigation
                    element.removeAttribute('onclick');
                }
            });
            
            // Load dashboard data
            updateDashboardStats();
            updateRecentActivities();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isAdminAuthenticated()) {
                console.log('Page visible, checking session');
                // Reset auto logout timer if exists
                if (typeof startAutoLogoutTimer === 'function') {
                    startAutoLogoutTimer('admin');
                }
            }
        });

        // Handle page focus
        window.addEventListener('focus', function() {
            if (isAdminAuthenticated()) {
                console.log('Page focused, checking session');
                // Reset auto logout timer if exists
                if (typeof startAutoLogoutTimer === 'function') {
                    startAutoLogoutTimer('admin');
                }
            }
        });

        // Authentication functions ready

        // Feedback Report Functions
        let allFeedbacks = [];
        let filteredFeedbacks = [];
        let feedbackSystemEnabled = true; // Default enabled

        // Toggle Feedback System
        async function toggleFeedbackSystem() {
            try {
                await waitForFirebase();
                
                // Toggle the state
                feedbackSystemEnabled = !feedbackSystemEnabled;
                
                // Update Firebase setting
                await window.db.ref('settings/feedbackEnabled').set(feedbackSystemEnabled);
                
                // Update UI
                updateFeedbackToggleUI();
                
                // Show confirmation
                const status = feedbackSystemEnabled ? 'enabled' : 'disabled';
                alert(`Feedback system has been ${status} successfully!`);
                
            } catch (error) {
                console.error('Error toggling feedback system:', error);
                alert('Error updating feedback system. Please try again.');
            }
        }

        // Update Toggle Button UI
        function updateFeedbackToggleUI() {
            const toggleBtn = document.getElementById('feedbackToggleBtn');
            const toggleText = document.getElementById('feedbackToggleText');
            const toggleIcon = toggleBtn.querySelector('i');
            const statusIndicator = document.getElementById('feedbackStatusIndicator');
            
            if (feedbackSystemEnabled) {
                toggleBtn.className = 'btn';
                toggleBtn.style.background = '#EF4444';
                toggleBtn.style.color = 'white';
                toggleIcon.className = 'fas fa-toggle-on';
                toggleText.textContent = 'Disable Feedback';
                
                // Update status indicator
                statusIndicator.textContent = 'ENABLED';
                statusIndicator.style.background = '#10B981';
                statusIndicator.style.color = 'white';
            } else {
                toggleBtn.className = 'btn';
                toggleBtn.style.background = '#10B981';
                toggleBtn.style.color = 'white';
                toggleIcon.className = 'fas fa-toggle-off';
                toggleText.textContent = 'Enable Feedback';
                
                // Update status indicator
                statusIndicator.textContent = 'DISABLED';
                statusIndicator.style.background = '#EF4444';
                statusIndicator.style.color = 'white';
            }
        }

        // Load Feedback System Status
        async function loadFeedbackSystemStatus() {
            try {
                await waitForFirebase();
                
                const statusSnapshot = await window.db.ref('settings/feedbackEnabled').once('value');
                if (statusSnapshot.exists()) {
                    feedbackSystemEnabled = statusSnapshot.val();
                } else {
                    // Set default if not exists
                    feedbackSystemEnabled = true;
                    await window.db.ref('settings/feedbackEnabled').set(true);
                }
                
                updateFeedbackToggleUI();
                
            } catch (error) {
                console.error('Error loading feedback system status:', error);
                feedbackSystemEnabled = true; // Default to enabled
                updateFeedbackToggleUI();
            }
        }

        // Show Feedback Report Section
        function showFeedbackReport() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('feedbackReportSection').style.display = 'block';
            document.querySelector('.page-title').textContent = 'Feedback Report';
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
            
            // Load feedback system status and data
            loadFeedbackSystemStatus();
            loadFeedbackData();
        }

        // Show Dashboard Section
        function showDashboard() {
            document.getElementById('feedbackReportSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.querySelector('.page-title').textContent = 'Dashboard Overview';
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('.nav-link[href="#"]').classList.add('active');
        }

        // Load Feedback Data from Firebase
        async function loadFeedbackData() {
            try {
                await waitForFirebase();
                
                const feedbackSnapshot = await window.db.ref('feedback').once('value');
                allFeedbacks = [];
                
                if (feedbackSnapshot.exists()) {
                    feedbackSnapshot.forEach(snap => {
                        const feedback = snap.val();
                        allFeedbacks.push({
                            id: snap.key,
                            ...feedback,
                            timestamp: feedback.timestamp || Date.now()
                        });
                    });
                }
                
                // Sort by timestamp descending
                allFeedbacks.sort((a, b) => b.timestamp - a.timestamp);
                
                // Update stats and populate filters
                await updateFeedbackStats();
                await populateFilters();
                
                // Show all feedbacks initially
                filteredFeedbacks = [...allFeedbacks];
                await displayFeedbacks();
                
            } catch (error) {
                console.error('Error loading feedback data:', error);
                document.getElementById('feedbackTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" style="padding: 2rem; text-align: center; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> Error loading feedback data
                        </td>
                    </tr>
                `;
            }
        }

        // Update Feedback Statistics
        async function updateFeedbackStats() {
            const totalFeedbacks = allFeedbacks.length;
            document.getElementById('totalFeedbacks').textContent = totalFeedbacks;
            
            if (totalFeedbacks === 0) {
                document.getElementById('averageRating').textContent = '0.0';
                document.getElementById('topRatedTeacher').textContent = '-';
                document.getElementById('thisMonthFeedbacks').textContent = '0';
                return;
            }
            
            // Calculate average rating
            let totalRating = 0;
            let ratingCount = 0;
            
            allFeedbacks.forEach(feedback => {
                if (feedback.ratings) {
                    const ratings = Object.values(feedback.ratings);
                    const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                    totalRating += avgRating;
                    ratingCount++;
                }
            });
            
            const averageRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : '0.0';
            document.getElementById('averageRating').textContent = averageRating;
            
            // Find top rated teacher
            const teacherRatings = {};
            allFeedbacks.forEach(feedback => {
                if (feedback.teacher && feedback.ratings) {
                    if (!teacherRatings[feedback.teacher]) {
                        teacherRatings[feedback.teacher] = { total: 0, count: 0 };
                    }
                    const ratings = Object.values(feedback.ratings);
                    const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                    teacherRatings[feedback.teacher].total += avgRating;
                    teacherRatings[feedback.teacher].count++;
                }
            });
            
            let topTeacher = '-';
            let topRating = 0;
            Object.keys(teacherRatings).forEach(teacher => {
                const avgRating = teacherRatings[teacher].total / teacherRatings[teacher].count;
                if (avgRating > topRating) {
                    topRating = avgRating;
                    topTeacher = teacher;
                }
            });
            
            // Get teacher name for display
            let displayTeacherName = topTeacher;
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        if (teacherId === topTeacher) {
                            displayTeacherName = teacher.firstName && teacher.lastName 
                                ? `${teacher.firstName} ${teacher.lastName}`.trim()
                                : teacher.name || topTeacher;
                        }
                    });
                }
            } catch (error) {
                console.error('Error resolving teacher name:', error);
            }
            
            document.getElementById('topRatedTeacher').textContent = displayTeacherName;
            
            // Count this month's feedbacks
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthCount = allFeedbacks.filter(feedback => {
                const feedbackDate = new Date(feedback.timestamp);
                return feedbackDate.getMonth() === currentMonth && feedbackDate.getFullYear() === currentYear;
            }).length;
            
            document.getElementById('thisMonthFeedbacks').textContent = thisMonthCount;
        }

        // Populate Filter Dropdowns
        async function populateFilters() {
            let studentData = {};
            const teachers = [...new Set(allFeedbacks.map(f => f.teacher).filter(Boolean))];
            const subjects = [...new Set(allFeedbacks.map(f => f.subject).filter(Boolean))];
            
            // Get student data for departments and classes
            const departments = new Set();
            const classes = new Set();
            
            try {
                // Get all students to populate department and class filters
                const studentsSnapshot = await window.db.ref('students').once('value');
                if (studentsSnapshot.exists()) {
                    studentsSnapshot.forEach(snap => {
                        const student = snap.val();
                        if (student.email) {
                            studentData[student.email] = {
                                department: student.department || student.branch,
                                class: student.year
                            };
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading student data for filters:', error);
            }
            
            // Populate department filter
            const departmentFilter = document.getElementById('departmentFilter');
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            [...departments].sort().forEach(dept => {
                departmentFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
            });
            
            // Populate class filter
            const classFilter = document.getElementById('classFilter');
            classFilter.innerHTML = '<option value="">All Classes</option>';
            [...classes].sort().forEach(cls => {
                classFilter.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
            
            // Populate teacher filter with resolved names
            const teacherFilter = document.getElementById('teacherFilter');
            teacherFilter.innerHTML = '<option value="">All Teachers</option>';
            
            // Get teacher names for filter display
            let teacherNames = {};
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        const teacherName = teacher.firstName && teacher.lastName 
                            ? `${teacher.firstName} ${teacher.lastName}`.trim()
                            : teacher.name || teacherId;
                        teacherNames[teacherId] = teacherName;
                    });
                }
            } catch (error) {
                console.error('Error loading teacher names for filter:', error);
            }
            
            teachers.forEach(teacherId => {
                const displayName = teacherNames[teacherId] || teacherId;
                teacherFilter.innerHTML += `<option value="${teacherId}">${displayName}</option>`;
            });
            
            // Populate subject filter
            const subjectFilter = document.getElementById('subjectFilter');
            subjectFilter.innerHTML = '<option value="">All Subjects</option>';
            subjects.forEach(subject => {
                subjectFilter.innerHTML += `<option value="${subject}">${subject}</option>`;
            });
        }

        // Filter Feedbacks
        async function filterFeedbacks() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const teacherFilter = document.getElementById('teacherFilter').value;
            const subjectFilter = document.getElementById('subjectFilter').value;
            const lectureTypeFilter = document.getElementById('lectureTypeFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            // Get student data for department and class filtering
            let studentData = {};
            if (departmentFilter || classFilter) {
                try {
                    const studentsSnapshot = await window.db.ref('students').once('value');
                    if (studentsSnapshot.exists()) {
                        studentsSnapshot.forEach(snap => {
                            const student = snap.val();
                            if (student.email) {
                                studentData[student.email] = {
                                    department: student.department || student.branch,
                                    class: student.year
                                };
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading student data for filtering:', error);
                }
            }
            
            filteredFeedbacks = allFeedbacks.filter(feedback => {
                // Department filter
                if (departmentFilter && feedback.studentId) {
                    const student = studentData[feedback.studentId];
                    if (!student || student.department !== departmentFilter) return false;
                }
                
                // Class filter
                if (classFilter && feedback.studentId) {
                    const student = studentData[feedback.studentId];
                    if (!student || student.class !== classFilter) return false;
                }
                
                // Teacher filter
                if (teacherFilter && feedback.teacher !== teacherFilter) return false;
                
                // Subject filter
                if (subjectFilter && feedback.subject !== subjectFilter) return false;
                
                // Lecture type filter
                if (lectureTypeFilter && feedback.lectureType !== lectureTypeFilter) return false;
                
                // Rating filter
                if (ratingFilter && feedback.ratings) {
                    const ratings = Object.values(feedback.ratings);
                    const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                    const minRating = parseInt(ratingFilter);
                    if (avgRating < minRating) return false;
                }
                
                return true;
            });
            
            displayFeedbacks();
        }

        // Display Feedbacks in Table
        async function displayFeedbacks() {
            const tbody = document.getElementById('feedbackTableBody');
            
            if (filteredFeedbacks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="padding: 2rem; text-align: center; color: var(--text-light);">
                            <i class="fas fa-search"></i> No feedback found matching the filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get student data for department and class display
            let studentData = {};
            try {
                const studentsSnapshot = await window.db.ref('students').once('value');
                if (studentsSnapshot.exists()) {
                    studentsSnapshot.forEach(snap => {
                        const student = snap.val();
                        if (student.email) {
                            studentData[student.email] = {
                                department: student.department || student.branch || 'N/A',
                                class: student.year || 'N/A'
                            };
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading student data for display:', error);
            }
            
            // Get teacher data for name resolution
            let teacherData = {};
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        const teacherName = teacher.firstName && teacher.lastName 
                            ? `${teacher.firstName} ${teacher.lastName}`.trim()
                            : teacher.name || teacherId;
                        teacherData[teacherId] = teacherName;
                    });
                }
            } catch (error) {
                console.error('Error loading teacher data for display:', error);
            }
            
            tbody.innerHTML = '';
            
            filteredFeedbacks.forEach(feedback => {
                const date = new Date(feedback.timestamp).toLocaleDateString();
                
                // Get student info
                const student = studentData[feedback.studentId] || { department: 'N/A', class: 'N/A' };
                
                // Calculate overall rating
                let overallRating = 0;
                if (feedback.ratings) {
                    const ratings = Object.values(feedback.ratings);
                    overallRating = (ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length).toFixed(1);
                }
                
                // Generate star display
                const stars = generateStars(parseFloat(overallRating));
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--border)';
                row.innerHTML = `
                    <td style="padding: 1rem;">${feedback.studentName || 'Unknown'}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: rgba(59, 130, 246, 0.1); color: var(--info); border-radius: 4px; font-size: 0.875rem;">
                            ${student.department}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: rgba(245, 158, 11, 0.1); color: var(--warning); border-radius: 4px; font-size: 0.875rem;">
                            ${student.class}
                        </span>
                    </td>
                    <td style="padding: 1rem;">${teacherData[feedback.teacher] || feedback.teacher || 'N/A'}</td>
                    <td style="padding: 1rem;">${feedback.subject || 'N/A'}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: ${feedback.lectureType === 'Theory' ? 'rgba(79, 70, 229, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; color: ${feedback.lectureType === 'Theory' ? 'var(--primary)' : 'var(--secondary)'}; border-radius: 4px; font-size: 0.875rem;">
                            ${feedback.lectureType || 'N/A'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${stars}
                            <span style="font-weight: 500;">${overallRating}</span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">${date}</td>
                    <td style="padding: 1rem;">
                        <button onclick="viewFeedbackDetails('${feedback.id}')" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Generate Star Rating Display
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star" style="color: #fbbf24;"></i>';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt" style="color: #fbbf24;"></i>';
                } else {
                    stars += '<i class="far fa-star" style="color: #d1d5db;"></i>';
                }
            }
            return stars;
        }

        // View Feedback Details
        async function viewFeedbackDetails(feedbackId) {
            const feedback = allFeedbacks.find(f => f.id === feedbackId);
            if (!feedback) return;
            
            // Resolve teacher name
            let teacherName = feedback.teacher || 'N/A';
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        if (teacherId === feedback.teacher) {
                            teacherName = teacher.firstName && teacher.lastName 
                                ? `${teacher.firstName} ${teacher.lastName}`.trim()
                                : teacher.name || feedback.teacher;
                        }
                    });
                }
            } catch (error) {
                console.error('Error resolving teacher name in details:', error);
            }
            
            let detailsHtml = `
                <div style="max-width: 600px;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">Feedback Details</h4>
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p><strong>Student:</strong> ${feedback.studentName || 'Unknown'}</p>
                        <p><strong>Teacher:</strong> ${teacherName}</p>
                        <p><strong>Subject:</strong> ${feedback.subject || 'N/A'}</p>
                        <p><strong>Lecture Type:</strong> ${feedback.lectureType || 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(feedback.timestamp).toLocaleString()}</p>
                    </div>
            `;
            
            if (feedback.ratings) {
                detailsHtml += '<h5 style="margin-bottom: 0.5rem;">Detailed Ratings:</h5><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';
                
                const ratingLabels = {
                    knowledge: 'Subject Knowledge',
                    clarity: 'Clarity of Explanation',
                    punctuality: 'Punctuality',
                    doubts: 'Doubt Clearing',
                    interaction: 'Student Interaction',
                    control: 'Class Control',
                    aids: 'Teaching Aids',
                    motivation: 'Motivation',
                    quality: 'Overall Quality'
                };
                
                Object.entries(feedback.ratings).forEach(([key, value]) => {
                    const label = ratingLabels[key] || key;
                    const stars = generateStars(value);
                    detailsHtml += `
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border);">
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${label}</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${stars}
                                <span>${value}/5</span>
                            </div>
                        </div>
                    `;
                });
                
                detailsHtml += '</div>';
            }
            
            detailsHtml += '</div>';
            
            // Show in a modal-like alert
            const popup = window.open('', '_blank', 'width=700,height=600,scrollbars=yes,resizable=yes');
            popup.document.write(`
                <html>
                    <head>
                        <title>Feedback Details</title>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <style>
                            body { font-family: Arial, sans-serif; padding: 2rem; background: #f9fafb; }
                            .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            ${detailsHtml}
                            <button onclick="window.close()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #4F46E5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </body>
                </html>
            `);
        }
    </script>
</body>
</html> 