<!DOCTYPE html>
<script>
// Global Firebase Offline Fallback (must be first)
(function() {
    if (typeof window.firebase === 'undefined') {
        window.firebaseOfflineMode = false;
        window.firebase = {
            database: function() {
                window.firebaseOfflineMode = true;
                return {
                    ref: function() { return { on: function() {}, once: function() {}, off: function() {}, set: function() {}, update: function() {}, remove: function() {} }; }
                };
            },
            auth: function() {
                window.firebaseOfflineMode = true;
                return {
                    onAuthStateChanged: function(cb) { cb(null); return function(){}; },
                    signOut: function() { return Promise.resolve(); },
                    currentUser: null
                };
            },
            apps: [],
        };
    }
})();
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Reports - BVIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs: Add these at the top -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --bg-light: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-light);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            margin-bottom: 40px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
            color: var(--white);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 10px;
            text-transform: none;
            letter-spacing: normal;
            background: none;
            -webkit-text-fill-color: unset;
        }

        .page-subtitle {
            color: var(--white);
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
            font-weight: normal;
        }

        /* Remove unused styles */
        .title-section, .subtitle-section, .floating-shapes {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-header {
                padding: 15px;
                margin-bottom: 30px;
            }

            .page-title {
                font-size: 2rem;
            }

            .page-subtitle {
                font-size: 1rem;
            }
        }

        .filter-container {
            background: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.95rem;
        }

        select, input[type="date"] {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-dark);
            background: var(--bg-light);
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: var(--white);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 20px;
            text-align: center;
        }

        .table-container {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        /* Modern table styles */
        .attendance-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .attendance-table th {
            background: #4F46E5;
            color: white;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attendance-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #E5E7EB;
            font-size: 0.95rem;
            color: #1F2937;
        }

        .attendance-table tr:last-child td {
            border-bottom: none;
        }

        .attendance-table tr:hover {
            background: #F9FAFB;
        }

        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge.good {
            background: #DCFCE7;
            color: #15803D;
        }

        .status-badge.low {
            background: #FEF3C7;
            color: #B45309;
        }

        .status-badge.critical {
            background: #FEE2E2;
            color: #B91C1C;
        }

        /* Attendance counts */
        .attendance-count {
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .attendance-count i {
            font-size: 1rem;
        }

        .attendance-count.present {
            color: #15803D;
        }

        .attendance-count.absent {
            color: #B91C1C;
        }

        .attendance-count.total {
            color: #4F46E5;
        }

        /* Percentage column */
        .attendance-percentage {
            font-weight: 600;
            color: #1F2937;
        }

        /* Student info */
        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-roll {
            width: 40px;
            height: 40px;
            background: #EEF2FF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #4F46E5;
            font-size: 0.9rem;
        }

        .student-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .student-name {
            font-weight: 600;
            color: #111827;
        }

        .student-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6B7280;
            font-size: 0.85rem;
        }

        .student-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .student-meta i {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Export button */
        .export-btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
            margin-bottom: 20px;
        }

        .export-btn:hover {
            background: #4338CA;
            transform: translateY(-2px);
        }

        .export-btn i {
            font-size: 1.1rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .export-section {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        .attendance-filters {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: var(--primary);
            color: white;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .percentage-filter {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .percentage-input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .percentage-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .group-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
        }

        .edit-btn:hover {
            background: var(--primary);
            color: white;
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        .delete-btn:hover {
            background: #EF4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            }

        .modal-form {
            display: flex;
                flex-direction: column;
                gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dark);
            }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px auto;
            }

            .page-title {
                font-size: 2rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 20px;
            }
            .attendance-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .student-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }

        /* Edit Attendance Modal Styles */
        .student-info {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .student-info p {
            margin: 5px 0;
            font-size: 0.95rem;
        }

        .attendance-edit {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .attendance-edit .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .attendance-edit label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .attendance-edit input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        .attendance-preview {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--secondary);
        }

        .attendance-preview p {
            margin: 0;
            font-size: 1.1rem;
        }

        #newPercentage {
            color: var(--secondary);
            font-weight: bold;
        }

        /* Attendance Records Styles */
        .attendance-records h4 {
            margin: 15px 0 10px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .attendance-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: var(--bg-light);
            border-radius: 8px;
            border-left: 4px solid #e5e7eb;
        }

        .record-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .record-date {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .record-subject {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .record-type {
            color: var(--primary);
            font-size: 0.8rem;
            background: #e0e7ff;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .status-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-btn.present {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-btn.present:hover {
            background: #bbf7d0;
        }

        .status-btn.absent {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status-btn.absent:hover {
            background: #fecaca;
        }

        .attendance-summary {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .attendance-summary p {
            margin: 0;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Attendance Reports</h1>
            <p class="page-subtitle">View and analyze student attendance data</p>
        </div>

        <!-- Filters Section -->
        <div class="filter-container">
            <h3 class="filter-title">
                <i class="fas fa-filter"></i>
                Filter Reports
            </h3>
            <div class="filter-grid">
                <div class="form-group">
                    <label for="department">Department</label>
                    <select id="department" onchange="updateDivisionOptions()">
                        <option value="">All Departments</option>
                        <option value="CT">Computer Technology</option>
                        <option value="IT">Information Technology (IT)</option>
                        <option value="ME">Mechanical Engineering</option>
                        <option value="CE">Civil Engineering</option>
                        <option value="EE">Electrical Engineering (EE)</option>
                        <option value="ET">Electronics & Telecommunication (ET)</option>
                        <option value="AI">Artificial Intelligence (AI)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <select id="year">
                        <option value="">All Years</option>
                        <option value="FY">First Year</option>
                        <option value="SY">Second Year</option>
                        <option value="TY">Third Year</option>
                        <option value="BE">Final Year</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="division">Division</label>
                    <select id="division" disabled>
                        <option value="">All Divisions</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subject">Subject</label>
                    <input type="text" id="subject" placeholder="Enter subject name">
                </div>
                <div class="form-group">
                    <label for="startDate">From Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">To Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="form-group">
                    <label for="percentageFilter">Attendance Filter</label>
                    <select id="percentageFilter">
                        <option value="">All Students</option>
                        <option value="50">Below 50%</option>
                        <option value="60">Below 60%</option>
                        <option value="70">Below 70%</option>
                        <option value="75">Below 75%</option>
                        <option value="85">Below 85%</option>
                        <option value="custom">Custom Percentage</option>
                    </select>
                </div>
                <div class="form-group" id="customPercentageGroup" style="display: none;">
                    <label for="customPercentage">Custom Percentage</label>
                    <div class="input-group">
                        <input type="number" id="customPercentage" min="0" max="100" step="1" placeholder="Enter percentage">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button onclick="loadReports()" class="btn btn-primary">
                        <i class="fas fa-sync"></i>
                        Update Reports
            </button>
                </div>
            </div>
        </div>

        <!-- Load and Export Buttons -->
        <div class="action-buttons" style="margin: 20px 0; text-align: center;">
            <button onclick="loadReports()" class="btn btn-primary" style="margin-right: 10px;">
                <i class="fas fa-search"></i>
                Load Reports
            </button>
            <button onclick="exportToExcel()" class="btn btn-success" style="margin-right: 10px;">
                <i class="fas fa-file-excel"></i>
                Export to Excel
            </button>
            <button onclick="confirmDeleteAllAttendance()" class="btn btn-danger">
                <i class="fas fa-trash"></i>
                Delete All Attendance
            </button>
        </div>

        <!-- Confirmation Modal -->
        <div id="deleteConfirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Confirm Delete</h3>
                    <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="color: #dc2626; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        Warning: This action cannot be undone!
                    </p>
                    <p>Are you sure you want to delete all attendance records?</p>
                </div>
                <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                    <button onclick="closeDeleteModal()" class="btn btn-secondary" style="margin-right: 10px;">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button onclick="deleteAllAttendance()" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Delete All
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Section -->
                <div class="table-container">
            <table class="attendance-table">
                        <thead>
                            <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                        </th>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Year</th>
                        <th>Division</th>
                        <th>Subject</th>
                        <th>Lecture Type</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Percentage</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                        <!-- Table content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Use the global waitForFirebase function from firebase-config.js
        // No local function needed - just use window.waitForFirebase directly
        // Department mapping - same as in student and teacher sections
        const departmentFullNames = {
            'CT': 'Computer Technology',
            'IT': 'Information Technology',
            'ME': 'Mechanical Engineering', 
            'CE': 'Civil Engineering',
            'EE': 'Electrical Engineering',
            'ET': 'Electronics & Telecommunication',
            'AI': 'Artificial Intelligence',
            'CM': 'Computer Technology',
            'CIVIL': 'Civil Engineering',
            'COMP': 'Computer Technology',
            'MECH': 'Mechanical Engineering',
            'ENTC': 'Electronics & Telecommunication'
        };

        // Function to get department full name
        function getDepartmentFullName(code) {
            if (!code) return '-';
            // First try exact match
            if (departmentFullNames[code]) {
                return departmentFullNames[code];
            }
            // Try uppercase
            if (departmentFullNames[code.toUpperCase()]) {
                return departmentFullNames[code.toUpperCase()];
            }
            // If no match found, return the code itself
            console.log('Department code not found in mapping:', code);
            return code;
        }

        function getDepartmentCode(fullName) {
            const departmentMap = {
                'Computer Technology': 'CT',
                'Information Technology': 'IT',
                'Mechanical Engineering': 'ME',
                'Civil Engineering': 'CE',
                'Electrical Engineering': 'EE',
                'Electronics & Telecommunication': 'ET',
                'Artificial Intelligence': 'AI'
            };
            return departmentMap[fullName] || fullName;
        }

        function getYearCode(yearName) {
            const yearMap = {
                'First': 'FY',
                'Second': 'SY',
                'Third': 'TY',
                'Fourth': 'BE',
                'FY': 'FY',
                'SY': 'SY',
                'TY': 'TY',
                'BE': 'BE'
            };
            return yearMap[yearName] || yearName;
        }

        // Add this to your existing styles
        const additionalStyles = `
            .input-group {
                display: flex;
                align-items: center;
            }
            .input-group-text {
                padding: 8px 12px;
                background: #f3f4f6;
                border: 1px solid #e5e7eb;
                border-left: none;
                border-radius: 0 8px 8px 0;
            }
            #customPercentage {
                border-radius: 8px 0 0 8px;
            }
            .export-buttons .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            .btn-success {
                background: #10B981;
                color: white;
            }
            .btn-success:hover {
                background: #059669;
            }
            .btn-danger {
                background: #EF4444;
                color: white;
            }
            .btn-danger:hover {
                background: #DC2626;
            }
        `;

        // Add styles to document
        const styleSheet = document.createElement("style");
        styleSheet.innerText = additionalStyles;
        document.head.appendChild(styleSheet);
        
        console.log('Firebase services ready');

        // Check authentication
        async function checkAuth() {
            console.log('Checking authentication...');
            
            // Wait for Firebase initialization
            if (typeof window.waitForFirebase === 'function') {
                await window.waitForFirebase();
            }
            
            const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn');
            const isTeacherLoggedIn = sessionStorage.getItem('isTeacherLoggedIn');
            const userRole = sessionStorage.getItem('userRole');
            const adminId = sessionStorage.getItem('adminId');
            const teacherId = sessionStorage.getItem('teacherId');
            
            console.log('Session storage:', { 
                isAdminLoggedIn, 
                isTeacherLoggedIn, 
                userRole, 
                adminId, 
                teacherId 
            });
            
            // Enhanced admin detection
            const isAdmin = isAdminLoggedIn === 'true' || userRole === 'admin' || adminId;
            const isTeacher = isTeacherLoggedIn === 'true' || userRole === 'teacher' || teacherId;
            
            console.log('User permissions:', { isAdmin, isTeacher });
            
            // Store enhanced permissions globally
            window.currentUserPermissions = {
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                canDelete: isAdmin,
                canEdit: isAdmin || isTeacher,
                canView: isAdmin || isTeacher
            };
            
            if (!isAdmin && !isTeacher) {
                console.log('No valid session found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Show admin-specific UI elements if user is admin
            if (isAdmin) {
                console.log('User has admin privileges');
                showAdminFeatures();
            }
            
            // Check Firebase auth (with safety check) - but don't redirect if no user
            if (window.auth && window.auth.onAuthStateChanged) {
                window.auth.onAuthStateChanged((user) => {
                if (!user) {
                    console.log('No Firebase user found, but continuing with session auth');
                    // Don't redirect, just continue with session authentication
                }
                
                if (user) {
                    console.log('User authenticated:', user.uid);
                }
                
                // Initialize page regardless of Firebase auth status
                initializePage();
                });
            } else {
                console.log('Firebase auth not available, using session only');
                initializePage();
            }
        }

        // Initialize page
        function initializePage() {
            console.log('Initializing page...');

            // Set default date range (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];
            
            // Set default department to empty (All Departments)
            document.getElementById('department').value = '';
            
            // Set up event listeners
            document.getElementById('department').addEventListener('change', function() {
                console.log('Department changed to:', this.value);
                loadReports();
            });
            document.getElementById('year').addEventListener('change', loadReports);
            document.getElementById('division').addEventListener('change', loadReports);
            document.getElementById('startDate').addEventListener('change', loadReports);
            document.getElementById('endDate').addEventListener('change', loadReports);
            document.getElementById('percentageFilter').addEventListener('change', loadReports);
            document.getElementById('customPercentage').addEventListener('input', loadReports);

            // Show/hide custom percentage input
            document.getElementById('percentageFilter').addEventListener('change', function() {
                const customGroup = document.getElementById('customPercentageGroup');
                customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
            });

            // Load initial reports
            console.log('About to call loadReports()...');
            loadReports();
            console.log('loadReports() called');
        }

        // Function to ensure current user's teacher name is properly set
        function ensureCurrentUserTeacherName() {
            console.log('Ensuring current user teacher name is set...');
            
            // Get current user info
            const currentUserId = sessionStorage.getItem('teacherId');
            const firebaseUserId = window.auth && window.auth.currentUser ? window.auth.currentUser.uid : null;
            const currentUserEmail = window.auth && window.auth.currentUser ? window.auth.currentUser.email : null;
            
            console.log('Current user info:', { currentUserId, firebaseUserId, currentUserEmail });
            
            // Check if we already have a good teacher name
            const existingName = sessionStorage.getItem('teacherName');
            console.log('Existing teacher name in session:', existingName);
            
            // If we have "My Account" or similar generic names, replace them
            if (!existingName || existingName === 'null' || existingName === 'My Account' || 
                existingName === 'Teacher' || existingName === 'Unknown Teacher' || 
                existingName === 'admin' || existingName === 'Admin' || existingName === 'ADMIN' || 
                existingName.trim() === '') {
                
                console.log('Need to improve teacher name. Current name:', existingName);
                
                let betterName = null;
                
                // Try to get name from Firebase Auth
                if (window.auth && window.auth.currentUser) {
                    const user = window.auth.currentUser;
                    console.log('Firebase user info:', { displayName: user.displayName, email: user.email });
                    
                    if (user.displayName && user.displayName.trim() !== '' && user.displayName !== 'My Account') {
                        betterName = user.displayName.trim();
                        console.log('Found better name from Firebase Auth displayName:', betterName);
                    } else if (user.email) {
                        // Extract name from email
                        const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                        betterName = emailName.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                        console.log('Generated name from email:', betterName);
                    }
                }
                
                // Try localStorage as backup
                if (!betterName) {
                    const localName = localStorage.getItem('teacherName');
                    if (localName && localName !== 'null' && localName !== 'My Account' && localName.trim() !== '') {
                        betterName = localName;
                        console.log('Found name in localStorage:', betterName);
                    }
                }
                
                // Try userName from localStorage
                if (!betterName) {
                    const userName = localStorage.getItem('userName');
                    if (userName && userName !== 'null' && userName !== 'My Account' && userName.trim() !== '') {
                        betterName = userName;
                        console.log('Found userName in localStorage:', betterName);
                    }
                }
                
                // If we found a better name, update everything
                if (betterName && betterName !== 'My Account') {
                    console.log('Updating teacher name to:', betterName);
                    
                    // Convert to uppercase if it looks like a full name
                    if (betterName.split(' ').length >= 2) {
                        betterName = betterName.toUpperCase();
                    }
                    
                    // Update session storage
                    sessionStorage.setItem('teacherName', betterName);
                    
                    // Update localStorage as backup
                    localStorage.setItem('teacherName', betterName);
                    
                    // Update global mapping
                    if (currentUserId && window.teacherIdToName) {
                        window.teacherIdToName[currentUserId] = betterName;
                        console.log('Updated global teacher mapping for current user');
                    }
                    
                    // Try to create/update teacher record in Firebase
                    if (currentUserId && window.db) {
                        (async () => {
                            try {
                                const teacherRef = window.db.ref(`teachers/${currentUserId}`);
                                const snapshot = await teacherRef.once('value');
                                
                                if (!snapshot.exists()) {
                                    // Create new teacher record
                                    const teacherData = {
                                        name: betterName,
                                        teacherId: currentUserId,
                                        email: currentUserEmail || '',
                                        addedAutomatically: true,
                                        needsCompletion: true,
                                        createdAt: new Date().toISOString()
                                    };
                                    
                                    await teacherRef.set(teacherData);
                                    console.log('Teacher record created successfully for:', betterName);
                                    
                                    // Show success notification
                                    showNotification('Teacher Profile Updated', 
                                        `Your name has been updated to "${betterName}". Your attendance records will now show your correct name.`, 
                                        'success');
                                } else {
                                    // Update existing record if name is different
                                    const existingData = snapshot.val();
                                    if (!existingData.name || existingData.name === 'My Account' || 
                                        existingData.name === 'admin' || existingData.name === 'Admin' || 
                                        existingData.name === 'ADMIN' || existingData.name !== betterName) {
                                        await teacherRef.update({ name: betterName });
                                        console.log('Teacher record updated with new name:', betterName);
                                        
                                        showNotification('Teacher Name Updated', 
                                            `Your name has been updated to "${betterName}".`, 
                                            'success');
                                    }
                                }
                                
                                // Refresh reports to show updated name
                                setTimeout(() => {
                                    loadReports();
                                }, 2000);
                                
                            } catch (error) {
                                console.error('Error updating teacher record:', error);
                            }
                        })();
                    }
                } else {
                    console.log('Could not find a better name, keeping current name');
                }
            } else {
                console.log('Teacher name looks good:', existingName);
            }
        }
        
        // Function to find teacher name using comprehensive search
        function findTeacherNameComprehensive(teacherId) {
            // Try direct lookup in teachers node (window.allTeachersData)
            if (window.allTeachersData && window.allTeachersData[teacherId]) {
                const teacher = window.allTeachersData[teacherId];
                if (teacher.firstName && teacher.lastName) {
                    return teacher.firstName + ' ' + teacher.lastName;
                } else if (teacher.name) {
                    return teacher.name;
                }
            }
            return null;
        }

        // Function to show admin-specific features
        function showAdminFeatures() {
            console.log('Showing admin features...');
            
            // Enable delete buttons and admin-only features
            const deleteButtons = document.querySelectorAll('.admin-only, .delete-btn');
            deleteButtons.forEach(btn => {
                btn.style.display = 'block';
                btn.disabled = false;
            });
            
            // Show admin controls in the UI
            const adminControls = document.querySelectorAll('.admin-controls');
            adminControls.forEach(control => {
                control.style.display = 'block';
            });
            
            // Admin badge removed as per user request
            // const headerTitle = document.querySelector('h1');
            // if (headerTitle && !headerTitle.querySelector('.admin-badge')) {
            //     const adminBadge = document.createElement('span');
            //     adminBadge.className = 'admin-badge';
            //     adminBadge.style.cssText = `
            //         background: #DC2626;
            //         color: white;
            //         padding: 4px 8px;
            //         border-radius: 4px;
            //         font-size: 0.8em;
            //         margin-left: 10px;
            //         font-weight: normal;
            //     `;
            //     adminBadge.textContent = 'ADMIN';
            //     headerTitle.appendChild(adminBadge);
            // }
            
            console.log('Admin features enabled successfully');
        }
        
        // Function to show notifications to user
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#4F46E5';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                font-family: 'Segoe UI', sans-serif;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 4px;">${title}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">${message}</div>
                    </div>
                    <button onclick="this.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">×</button>
                </div>
            `;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 8000);
        }
        
        // Call checkAuth when page loads
        window.onload = function() {
            checkAuth();
            // Set a delay to ensure Firebase Auth is ready, then ensure teacher name
            setTimeout(ensureCurrentUserTeacherName, 1500);
        };

        // Add this new function to handle division options
        function updateDivisionOptions() {
            const departmentSelect = document.getElementById('department');
            const divisionSelect = document.getElementById('division');
            
            // Clear current selection
            divisionSelect.value = '';
            
            // Enable/disable and update divisions based on department
            if (departmentSelect.value === 'CT') {
                divisionSelect.disabled = false;
                // Clear existing options
                divisionSelect.innerHTML = `
                    <option value="">All Divisions</option>
                    <option value="A">Division A</option>
                    <option value="B">Division B</option>
                    <option value="C">Division C</option>
                `;
            } else {
                divisionSelect.disabled = true;
                divisionSelect.innerHTML = '<option value="">All Divisions</option>';
            }
            
            // Reload reports with new filters
            loadReports();
        }

        // Global comprehensive teacher lookup function with enhanced fallback
        function getTeacherNameById(teacherId, teachersData, teacherNames) {
            // Try direct lookup in teachersData by UID
            if (teachersData && teachersData[teacherId]) {
                console.log('Found in mapping:', teacherNames[teacherId]);
                return teacherNames[teacherId];
            }

            // 0. Check teacherUidToCode mapping (new method)
            if (window.teacherUidToCode && window.teacherUidToCode[teacherId]) {
                const teacherCode = window.teacherUidToCode[teacherId];
                console.log('Found teacher code in UID mapping:', teacherCode);
                
                // Now look up the teacher by this code in teachersData
                for (const [id, teacher] of Object.entries(teachersData)) {
                    if (teacher.code && teacher.code.trim().toUpperCase() === teacherCode.trim().toUpperCase()) {
                        let name = '';
                        if (teacher.name && teacher.name.trim() !== '') {
                            name = teacher.name.trim();
                        } else if (teacher.firstName || teacher.lastName) {
                            name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                        } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                            name = teacher.displayName.trim();
                        }
                        if (name) {
                            console.log('Resolved teacher name via UID mapping:', name);
                            teacherNames[teacherId] = name;
                            return name;
                        }
                    }
                }
                
                // If we have the code but couldn't find the teacher, at least try to use the code
                console.log('Could not find teacher data for code, using code as fallback:', teacherCode);
                teacherNames[teacherId] = teacherCode;
                return teacherCode;
            }

            // 1. Try direct UID lookup (object key)
            if (teachersData[teacherId]) {
                const teacher = teachersData[teacherId];
                let name = '';
                if (teacher.name && teacher.name.trim() !== '') {
                    name = teacher.name.trim();
                } else if (teacher.firstName || teacher.lastName) {
                    name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                    name = teacher.displayName.trim();
                } else if (teacher.email) {
                    const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                    name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                }
                if (name) {
                    teacherNames[teacherId] = name;
                    return name;
                }
            }

            // 2. Try teacherId/code/email fields inside each teacher object
            for (const [id, teacher] of Object.entries(teachersData)) {
                // Check by teacherId
                if (teacher.teacherId && teacher.teacherId.trim().toUpperCase() === teacherId.trim().toUpperCase()) {
                    let name = '';
                    if (teacher.name && teacher.name.trim() !== '') {
                        name = teacher.name.trim();
                    } else if (teacher.firstName || teacher.lastName) {
                        name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                    } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                        name = teacher.displayName.trim();
                    } else if (teacher.email) {
                        const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                        name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }
                    if (name) {
                        teacherNames[teacherId] = name;
                        return name;
                    }
                }
                // Check by code
                if (teacher.code && teacher.code.trim().toUpperCase() === teacherId.trim().toUpperCase()) {
                    let name = '';
                    if (teacher.name && teacher.name.trim() !== '') {
                        name = teacher.name.trim();
                    } else if (teacher.firstName || teacher.lastName) {
                        name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                    } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                        name = teacher.displayName.trim();
                    } else if (teacher.email) {
                        const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                        name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }
                    if (name) {
                        teacherNames[teacherId] = name;
                        return name;
                    }
                }
                // Check by email
                if (teacher.email && teacher.email.trim().toLowerCase() === teacherId.trim().toLowerCase()) {
                    let name = '';
                    if (teacher.name && teacher.name.trim() !== '') {
                        name = teacher.name.trim();
                    } else if (teacher.firstName || teacher.lastName) {
                        name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                    } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                        name = teacher.displayName.trim();
                    } else if (teacher.email) {
                        const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                        name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }
                    if (name) {
                        teacherNames[teacherId] = name;
                        return name;
                    }
                }
            }

            // 3. Enhanced fallback: Try to get name from session storage or Firebase Auth
            if (teacherId === sessionStorage.getItem('teacherId') || 
                (window.auth && window.auth.currentUser && window.auth.currentUser.uid === teacherId)) {
                
                // Try to get name from session storage first
                const sessionTeacherName = sessionStorage.getItem('teacherName');
                if (sessionTeacherName && sessionTeacherName !== 'null' && sessionTeacherName.trim() !== '') {
                    console.log('Found teacher name in session storage:', sessionTeacherName);
                    teacherNames[teacherId] = sessionTeacherName;
                    return sessionTeacherName;
                }
                
                // Try to get name from Firebase Auth user
                if (window.auth && window.auth.currentUser) {
                    const user = window.auth.currentUser;
                    let authName = '';
                    
                    if (user.displayName && user.displayName.trim() !== '') {
                        authName = user.displayName.trim();
                    } else if (user.email) {
                        // Extract name from email
                        const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                        authName = emailName.split(' ').map(word =>
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                    }
                    
                    if (authName) {
                        console.log('Found teacher name from Firebase Auth:', authName);
                        teacherNames[teacherId] = authName;
                        // Also save to session storage for future use
                        sessionStorage.setItem('teacherName', authName);
                        return authName;
                    }
                }
            }

            // Not found
            console.log('Teacher not found for ID:', teacherId);
            return 'Teacher';
        }

        // Function to automatically add missing teacher record
        async function addMissingTeacherRecord(teacherId, teacherName) {
            try {
                console.log('Adding missing teacher record:', { teacherId, teacherName });
                // Check if record already exists to avoid duplicates
                const existingRecord = await window.db.ref(`teachers/${teacherId}`).once('value');
                if (existingRecord.exists()) {
                    console.log('Teacher record already exists, skipping creation');
                    return true;
                }
                // If teacherName is generic, set a placeholder
                let finalName = teacherName;
                if (!finalName || finalName.toLowerCase() === 'teacher' || finalName.toLowerCase() === 'admin') {
                    finalName = 'Enter Name';
                }
                const teacherData = {
                    name: finalName,
                    teacherId: teacherId,
                    email: window.auth && window.auth.currentUser ? window.auth.currentUser.email : '',
                    departments: [],
                    classes: [],
                    createdAt: new Date().toISOString(),
                    addedAutomatically: true,
                    needsCompletion: true // Flag to indicate this record needs admin attention
                };
                await window.db.ref(`teachers/${teacherId}`).set(teacherData);
                console.log('Missing teacher record added successfully');
                
                // Show notification to user
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10B981;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: 'Segoe UI', sans-serif;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Teacher Record Created</strong><br>
                            <small>Your profile has been added automatically. Attendance records will now show your name correctly.</small>
                        </div>
                        <button onclick="this.parentNode.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">×</button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Remove notification after 8 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 8000);
                
                return true;
            } catch (error) {
                console.error('Error adding missing teacher record:', error);
                
                // Show error notification
                const errorNotification = document.createElement('div');
                errorNotification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #EF4444;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: 'Segoe UI', sans-serif;
                `;
                errorNotification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>
                            <strong>Error Creating Profile</strong><br>
                            <small>Failed to create teacher record. Please contact admin for assistance.</small>
                        </div>
                        <button onclick="this.parentNode.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">×</button>
                    </div>
                `;
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    if (errorNotification.parentNode) {
                        errorNotification.parentNode.removeChild(errorNotification);
                    }
                }, 8000);
                
                return false;
            }
        }

        async function loadReports() {
            console.log('=== loadReports() function called ===');
            try {
                console.log('Waiting for Firebase...');
                if (window.waitForFirebase) {
                    await window.waitForFirebase();
                } else {
                    console.log('Global waitForFirebase not available, proceeding anyway');
                }
                console.log('Firebase initialized, starting to load reports...');
                
                // Check if Firebase is actually available
                if (!window.db) {
                    console.error('Firebase database not available - showing demo data');
                    
                    // Show demo data for testing
                    const demoStudents = [
                        {
                            id: 'demo1',
                            name: 'Demo Student 1',
                            rollNo: '001',
                            department: 'CT',
                            departmentName: 'Computer Technology',
                            year: 'SY',
                            division: 'A',
                            subject: 'Demo Subject',
                            teacherName: 'Demo Teacher',
                            present: 8,
                            absent: 2,
                            total: 10,
                            percentage: 80
                        },
                        {
                            id: 'demo2',
                            name: 'Demo Student 2',
                            rollNo: '002',
                            department: 'CT',
                            departmentName: 'Computer Technology',
                            year: 'SY',
                            division: 'A',
                            subject: 'Demo Subject',
                            teacherName: 'Demo Teacher',
                            present: 6,
                            absent: 4,
                            total: 10,
                            percentage: 60
                        }
                    ];
                    
                    console.log('Showing demo data:', demoStudents);
                    updateTable(demoStudents);
                    return;
                }

                // Get user type and ID from session storage
                const isTeacher = sessionStorage.getItem('isTeacherLoggedIn') === 'true';
                const teacherId = sessionStorage.getItem('teacherId');
                console.log('Current user:', { isTeacher, teacherId });

                if (!teacherId && isTeacher) {
                    console.error('Teacher ID not found in session');
                    showError(new Error('Teacher ID not found. Please login again.'));
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                // Get all teachers data first
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                const teachersData = teachersSnapshot.val() || {};
                console.log('All teachers data loaded:', teachersData);

                // Create comprehensive teacher name mapping
                const teacherNames = {};
                Object.entries(teachersData).forEach(([id, teacher]) => {
                    if (teacher) {
                        // Try different name field combinations
                        let teacherName = '';
                        if (teacher.name && teacher.name.trim() !== '') {
                            teacherName = teacher.name.trim();
                        } else if (teacher.firstName || teacher.lastName) {
                            teacherName = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                        } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                            teacherName = teacher.displayName.trim();
                        } else if (teacher.email) {
                            // Extract name from email and format it properly
                            const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                            teacherName = emailName.split(' ').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                            ).join(' ');
                        } else {
                            teacherName = 'Unknown Teacher';
                        }
                        
                        console.log('Mapping teacher:', {
                            id: id,
                            teacherName: teacherName,
                            originalData: teacher
                        });
                        
                        // Map by Firebase ID
                        teacherNames[id] = teacherName;
                        
                        // Map by teacherId if it exists and is different
                        if (teacher.teacherId && teacher.teacherId !== id && teacher.teacherId.trim() !== '') {
                            teacherNames[teacher.teacherId] = teacherName;
                        }
                        
                        // Map by email if it exists
                        if (teacher.email && teacher.email.trim() !== '') {
                            teacherNames[teacher.email] = teacherName;
                        }
                        
                        // Map by code if it exists
                        if (teacher.code && teacher.code.trim() !== '') {
                            teacherNames[teacher.code] = teacherName;
                        }
                        
                        // Map by any other identifier fields
                        const identifierFields = ['username', 'userId', 'empId', 'employeeId'];
                        identifierFields.forEach(field => {
                            if (teacher[field] && teacher[field].trim() !== '' && teacher[field] !== id) {
                                teacherNames[teacher[field]] = teacherName;
                            }
                        });
                    }
                });
                console.log('Teacher names mapping:', teacherNames);
                
                // Check if current user is missing from teachers database
                const currentTeacherId = sessionStorage.getItem('teacherId');
                if (currentTeacherId && !teacherNames[currentTeacherId] && !teachersData[currentTeacherId]) {
                    console.warn('Current user not found in teachers database:', currentTeacherId);
                    
                    // Show helpful notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #F59E0B;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        max-width: 400px;
                        font-family: 'Segoe UI', sans-serif;
                    `;
                    notification.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Teacher Profile Missing</strong><br>
                                <small>Your teacher profile is not found in the database. Attendance records will show as "Unknown Teacher" until this is resolved.</small>
                            </div>
                            <button onclick="this.parentNode.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">×</button>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Auto-remove after 10 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 10000);
                }
        
        // Function moved to global scope - see above

                const filters = {
                    department: document.getElementById('department').value,
                    year: document.getElementById('year').value,
                    division: document.getElementById('division').value,
                    subject: document.getElementById('subject').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    teacherId: teacherId,
                    teacherNames: teacherNames, // Pass all teacher names
                    teachersData: teachersData // Pass original teachers data for lookup
                };

                console.log('Applied filters:', filters);

                // Show loading state
                showLoadingState();

                try {
                    // First verify access
                    await window.db.ref('.info/connected').once('value');
                    console.log('Firebase connection verified');
                    
                    // Query attendance based on user type
                    let attendanceQuery = window.db.ref('attendance');
                    if (isTeacher && teacherId) {
                        console.log('Querying attendance for teacher:', teacherId);
                        attendanceQuery = attendanceQuery.orderByChild('teacherId').equalTo(teacherId);
                    }

                    const [attendanceSnapshot, studentsSnapshot] = await Promise.all([
                        attendanceQuery.once('value'),
                        window.db.ref('students').once('value')
                    ]);
                    
                    console.log('Data fetched successfully');
                    
                    const attendanceData = attendanceSnapshot.val() || {};
                    const studentsData = studentsSnapshot.val() || {};

                    console.log('Records found:', {
                        attendance: Object.keys(attendanceData).length,
                        students: Object.keys(studentsData).length
                    });
                    
                    // Debug: Log first few attendance records to see structure
                    console.log('Sample attendance records:');
                    Object.entries(attendanceData).slice(0, 3).forEach(([key, record]) => {
                        console.log('Record:', key, {
                            teacherId: record.teacherId,
                            teacherName: record.teacherName,
                            teacher: record.teacher,
                            createdBy: record.createdBy,
                            subject: record.subject,
                            date: record.date,
                            hasStudents: !!record.students
                        });
                    });

                    // Process and display data
                    console.log('Processing attendance data...');
                    const processedData = await processAttendanceData(attendanceData, studentsData, filters);
                    console.log('Processed data:', processedData.length, 'students found');
                    console.log('Sample processed data:', processedData.slice(0, 2));
                    updateTable(processedData);
                    console.log('Table updated successfully');

                } catch (error) {
                    console.error('Error fetching data:', error);
                    showError(error);
                }
            } catch (error) {
                console.error('Error in loadReports:', error);
                showError(error);
            }
        }

        async function processAttendanceData(attendanceData, studentsData, filters) {
            console.log('Processing attendance data with filters:', filters);
            
            const studentAttendance = {};
            let totalStudents = 0;
            let filteredStudents = 0;

            // First, find students who have attendance records
            Object.entries(attendanceData).forEach(([recordKey, record]) => {
                // Skip if not the teacher's record
                if (filters.teacherId && record.teacherId !== filters.teacherId) {
                    return;
                }

                if (record && record.students) {
                    // Get teacher name from mapping - try multiple approaches
                    let teacherName = 'Unknown Teacher';
                    
                    console.log('Resolving teacher name for record:', {
                        recordId: recordKey,
                        teacherId: record.teacherId,
                        teacherName: record.teacherName,
                        teacher: record.teacher,
                        createdBy: record.createdBy,
                        availableTeachers: Object.keys(filters.teacherNames)
                    });
                    
                    // Method 1: Direct teacher name from record
                    if (record.teacherName && record.teacherName !== 'Unknown Teacher' && record.teacherName.trim() !== '') {
                        teacherName = record.teacherName.trim();
                        console.log('Method 1 - Direct teacher name:', teacherName);
                    }
                    // Method 2: Teacher field from record
                    else if (record.teacher && record.teacher.trim() !== '') {
                        teacherName = record.teacher.trim();
                        console.log('Method 2 - Teacher field:', teacherName);
                    }
                    // Method 3: Look up by teacherId in mapping
                    else if (record.teacherId && filters.teacherNames[record.teacherId]) {
                        teacherName = filters.teacherNames[record.teacherId];
                        console.log('Method 3 - TeacherId mapping:', teacherName);
                    }
                    // Method 4: Look up by createdBy in mapping
                    else if (record.createdBy && filters.teacherNames[record.createdBy]) {
                        teacherName = filters.teacherNames[record.createdBy];
                        console.log('Method 4 - CreatedBy mapping:', teacherName);
                    }
                    // Method 5: Try to find teacher by partial match in mapping
                    else if (record.teacherId) {
                        // Try to find a teacher that contains this ID
                        for (const [id, name] of Object.entries(filters.teacherNames)) {
                            if (id.includes(record.teacherId) || record.teacherId.includes(id)) {
                                teacherName = name;
                                console.log('Method 5 - Partial match:', teacherName);
                                break;
                            }
                        }
                    }
                    // Method 6: Extract name from email if teacherId looks like email
                    if (teacherName === 'Unknown Teacher' && record.teacherId && record.teacherId.includes('@')) {
                        teacherName = record.teacherId.split('@')[0].replace(/[._]/g, ' ');
                        // Capitalize first letter of each word
                        teacherName = teacherName.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                        console.log('Method 6 - Email extraction:', teacherName);
                    }
                    // Method 7: Use createdBy as fallback if it's not an ID
                    else if (teacherName === 'Unknown Teacher' && record.createdBy && 
                             !record.createdBy.includes('-') && 
                             record.createdBy !== 'Unknown Teacher' && 
                             record.createdBy.trim() !== '') {
                        teacherName = record.createdBy.trim();
                        console.log('Method 7 - CreatedBy fallback:', teacherName);
                    }
                    // Method 8: Try to get teacher name from any available field
                    else if (teacherName === 'Unknown Teacher') {
                        // Look for any field that might contain teacher name
                        const possibleFields = ['teacherName', 'teacher', 'createdBy', 'teacherId'];
                        for (const field of possibleFields) {
                            if (record[field] && 
                                typeof record[field] === 'string' && 
                                record[field].trim() !== '' && 
                                record[field] !== 'Unknown Teacher' &&
                                !record[field].includes('-') &&
                                record[field].length > 2) {
                                teacherName = record[field].trim();
                                console.log('Method 8 - Found in field', field, ':', teacherName);
                                break;
                            }
                        }
                    }
                    
                    // Method 9: Enhanced lookup with fallback mechanism
                    if (teacherName === 'Unknown Teacher' && record.teacherId) {
                        // Try direct lookup in all teachers data
                        if (window.allTeachersData && window.allTeachersData[record.teacherId]) {
                            const teacher = window.allTeachersData[record.teacherId];
                            if (teacher.name && teacher.name !== 'My Account' && teacher.name !== 'admin') {
                                teacherName = teacher.name;
                                console.log('Method 9a - Direct teacher data lookup:', teacherName);
                            }
                        }
                        
                        // If still unknown, try enhanced lookup
                        if (teacherName === 'Unknown Teacher') {
                            const resolvedName = getTeacherNameById ? getTeacherNameById(record.teacherId, filters.teachersData, filters.teacherNames) : null;
                            if (resolvedName && resolvedName !== 'Unknown Teacher') {
                                teacherName = resolvedName;
                                console.log('Method 9b - Enhanced lookup resolved:', teacherName);
                            }
                        }
                        
                        // If this is the current user's record and we still can't find them
                        if (teacherName === 'Unknown Teacher') {
                            const currentTeacherId = sessionStorage.getItem('teacherId');
                            const currentAdminId = sessionStorage.getItem('adminId');
                            const currentFirebaseId = window.auth && window.auth.currentUser ? window.auth.currentUser.uid : null;
                            
                            if (record.teacherId === currentTeacherId || 
                                record.teacherId === currentAdminId || 
                                record.teacherId === currentFirebaseId) {
                                console.log('This is current user record, attempting to resolve name');
                                
                                // Try to get name from Firebase Auth or session
                                let fallbackName = null;
                                
                                // Check session storage first
                                const sessionName = sessionStorage.getItem('teacherName');
                                if (sessionName && sessionName !== 'null' && sessionName !== 'admin' && 
                                    sessionName !== 'Admin' && sessionName !== 'My Account' && sessionName.trim() !== '') {
                                    fallbackName = sessionName;
                                }
                                
                                // Check Firebase Auth
                                if (!fallbackName && window.auth && window.auth.currentUser) {
                                    const user = window.auth.currentUser;
                                    if (user.displayName && user.displayName.trim() !== '') {
                                        fallbackName = user.displayName.trim();
                                    } else if (user.email) {
                                        const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                                        fallbackName = emailName.split(' ').map(word =>
                                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                        ).join(' ');
                                    }
                                }
                                
                                if (fallbackName) {
                                    teacherName = fallbackName;
                                    // Always update the mapping immediately, regardless of DB write
                                    filters.teacherNames[record.teacherId] = fallbackName;
                                    filters.teachersData[record.teacherId] = {
                                        name: fallbackName,
                                        teacherId: record.teacherId,
                                        addedAutomatically: true
                                    };
                                    console.log('Method 9c - Current user fallback name:', fallbackName);
                                    // Attempt to add to DB asynchronously, but don't block UI
                                    addMissingTeacherRecord(record.teacherId, fallbackName).catch(error => {
                                        console.error('Failed to add missing teacher record:', error);
                                    });
                                } else {
                                    // Try one more time with comprehensive search
                                    const comprehensiveName = findTeacherNameComprehensive(record.teacherId);
                                    if (comprehensiveName) {
                                        teacherName = comprehensiveName;
                                        console.log('Method 9d - Comprehensive search found:', comprehensiveName);
                                    } else {
                                        teacherName = 'Current User';
                                        console.log('Method 9e - Fallback to Current User');
                                    }
                                }
                            } else {
                                // Try comprehensive search for any unknown teacher
                                const comprehensiveName = findTeacherNameComprehensive(record.teacherId);
                                if (comprehensiveName) {
                                    teacherName = comprehensiveName;
                                    console.log('Method 9f - Comprehensive search found:', comprehensiveName);
                                } else {
                                    teacherName = 'Unknown Teacher';
                                    console.log('Method 9g - Fallback to Unknown Teacher');
                                }
                            }
                        }
                    }
                    
                    // Method 10: If still Unknown Teacher, try comprehensive lookup on any ID fields
                    if (teacherName === 'Unknown Teacher') {
                        const idsToTry = [record.teacherId, record.createdBy];
                        for (const id of idsToTry) {
                            if (id && typeof id === 'string' && id.trim() !== '') {
                                const resolvedName = getTeacherNameById(id, filters.teachersData, filters.teacherNames);
                                if (resolvedName) {
                                    teacherName = resolvedName;
                                    console.log('Method 10 - Resolved ID to name:', teacherName);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // जर teacherName UIDसारखा किंवा 'Unknown Teacher' असेल, तर fallback वापरा
                    if (
                        !teacherName ||
                        teacherName === 'Unknown Teacher' ||
                        (teacherName.length > 20 && /^[A-Za-z0-9]{20,}$/.test(teacherName))
                    ) {
                        // fallbackName मिळवा (session/Firebase Auth)
                        let fallbackName = null;
                        const sessionName = sessionStorage.getItem('teacherName');
                        if (sessionName && sessionName !== 'null' && sessionName.trim() !== '' && sessionName.toLowerCase() !== 'admin') {
                            fallbackName = sessionName;
                        } else if (window.auth && window.auth.currentUser) {
                            const user = window.auth.currentUser;
                            if (user.displayName && user.displayName.trim() !== '' && user.displayName.toLowerCase() !== 'admin') {
                                fallbackName = user.displayName.trim();
                            } else if (user.email) {
                                const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                                if (emailName.toLowerCase() !== 'admin') {
                                    fallbackName = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                                }
                            }
                        }
                        teacherName = fallbackName || 'Teacher';
                        filters.teacherNames[record.teacherId] = teacherName;
                        filters.teachersData[record.teacherId] = {
                            name: teacherName,
                            teacherId: record.teacherId,
                            addedAutomatically: true
                        };
                        console.warn('Fallback teacher name वापरला:', teacherName);
                    }
                    
                    console.log('Teacher name resolution for record:', {
                        recordId: recordKey,
                        teacherId: record.teacherId,
                        resolvedTeacherName: teacherName,
                        recordTeacherName: record.teacherName,
                        recordTeacher: record.teacher,
                        createdBy: record.createdBy,
                        availableInMapping: record.teacherId ? !!filters.teacherNames[record.teacherId] : false
                    });

                    // Extract class info from record
                    let recordDepartment = '';
                    let recordYear = '';
                    let recordDivision = '';
                    if (record.class) {
                        // First try exact match pattern
                        const exactMatch = record.class.match(/^(FY|SY|TY|BE)(CT|IT|ME|CE|EE|ET|AI)(?:-([A-C]))?$/i);
                        if (exactMatch) {
                            recordYear = exactMatch[1].toUpperCase();
                            recordDepartment = exactMatch[2].toUpperCase();
                            recordDivision = exactMatch[3] ? exactMatch[3].toUpperCase() : '';
                        } else {
                            // Try to extract parts
                            const yearMatch = record.class.match(/(FY|SY|TY|BE)/i);
                            const deptMatch = record.class.match(/(CT|IT|ME|CE|EE|ET|AI|COMP|CIVIL|MECH|ENTC)/i);
                            const divMatch = record.class.match(/[^A-Z]([A-C])[^A-Z]/i);
                            
                            recordYear = yearMatch ? yearMatch[1].toUpperCase() : '';
                            recordDepartment = deptMatch ? deptMatch[1].toUpperCase() : '';
                            recordDivision = divMatch ? divMatch[1].toUpperCase() : '';
                            
                            // Map department codes
                            if (recordDepartment) {
                                switch (recordDepartment.toUpperCase()) {
                                    case 'COMP': recordDepartment = 'CT'; break;
                                    case 'CIVIL': recordDepartment = 'CE'; break;
                                    case 'MECH': recordDepartment = 'ME'; break;
                                    case 'ENTC': recordDepartment = 'ET'; break;
                                }
                            }
                        }
                        console.log('Parsed class code:', {
                            original: record.class,
                            year: recordYear,
                            department: recordDepartment,
                            division: recordDivision
                        });
                    }

                    Object.keys(record.students).forEach(studentId => {
                        if (studentsData[studentId]) {
                            totalStudents++;
                            const student = studentsData[studentId];
                            
                            // Get student's department, year and division
                            const studentDepartment = student.department || student.branch || recordDepartment || '-';
                            const studentDepartmentCode = getDepartmentCode(studentDepartment);
                            const studentYear = getYearCode(student.year || recordYear || '-');
                            const studentDivision = student.division || recordDivision || '-';
                            
                            console.log('Processing student:', {
                                name: student.name,
                                department: studentDepartmentCode,
                                year: studentYear,
                                division: studentDivision,
                                filters: filters
                            });

                            // Apply department filter
                            if (filters.department && studentDepartmentCode !== filters.department) {
                                console.log('Skipping student - department mismatch:', {
                                    student: student.name,
                                    studentDepartment: studentDepartmentCode,
                                    filterDepartment: filters.department
                                });
                                return;
                            }

                            // Apply year filter
                            if (filters.year && studentYear !== filters.year) {
                                console.log('Skipping student - year mismatch:', {
                                    student: student.name,
                                    studentYear,
                                    filterYear: filters.year
                                });
                                return;
                            }

                            // Apply division filter
                            if (filters.division && studentDivision !== filters.division) {
                                console.log('Skipping student - division mismatch:', {
                                    student: student.name,
                                    studentDivision,
                                    filterDivision: filters.division
                                });
                                return;
                            }

                            filteredStudents++;

                            // Create unique key for student-subject combination
                            const studentSubjectKey = `${studentId}_${record.subject || 'unknown'}`;
                            
                            // Initialize student-subject record if not exists
                            if (!studentAttendance[studentSubjectKey]) {
                                studentAttendance[studentSubjectKey] = {
                                    id: studentId,
                                    name: student.name || `${student.firstName || ''} ${student.lastName || ''}`.trim(),
                                    rollNo: student.rollNo,
                                    department: studentDepartmentCode,
                                    departmentName: getDepartmentFullName(studentDepartmentCode),
                                    year: studentYear,
                                    division: studentDivision,
                                    subject: record.subject || '-',
                                    lectureType: record.lectureType || 'theory',
                                    teacherName: (function() {
                                        // Always try to get the best possible teacher name
                                        let bestName = null;
                                        
                                        // Priority 1: Direct teacher name from record
                                        if (teacherName && 
                                            teacherName !== 'Unknown Teacher' && 
                                            teacherName !== 'My Account' && 
                                            teacherName !== 'Teacher' && 
                                            teacherName !== 'admin' && 
                                            teacherName !== 'Admin' && 
                                            teacherName !== 'ADMIN' && 
                                            !(teacherName.length > 20 && /^[A-Za-z0-9]{20,}$/.test(teacherName))) {
                                            bestName = teacherName;
                                        }
                                        
                                        // Priority 2: Session storage
                                        if (!bestName) {
                                            const sessionName = sessionStorage.getItem('teacherName');
                                            if (sessionName && sessionName !== 'null' && sessionName !== 'My Account' && sessionName.trim() !== '') {
                                                bestName = sessionName;
                                            }
                                        }
                                        
                                        // Priority 3: Firebase Auth current user
                                        if (!bestName && window.auth && window.auth.currentUser) {
                                            const user = window.auth.currentUser;
                                            if (user.displayName && user.displayName.trim() !== '' && user.displayName !== 'My Account') {
                                                bestName = user.displayName.trim();
                                            } else if (user.email) {
                                                const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                                                bestName = emailName.split(' ').map(word => 
                                                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                                ).join(' ');
                                            }
                                        }
                                        
                                        // Priority 4: Try record fields
                                        if (!bestName) {
                                            if (record.createdBy && record.createdBy !== 'Unknown Teacher' && record.createdBy.trim() !== '') {
                                                bestName = record.createdBy;
                                            } else if (record.teacherId && record.teacherId.includes('@')) {
                                                const emailName = record.teacherId.split('@')[0].replace(/[._]/g, ' ');
                                                bestName = emailName.split(' ').map(word => 
                                                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                                ).join(' ');
                                            }
                                        }
                                        
                                        // Final result
                                        if (bestName && bestName.split(' ').length >= 2) {
                                            return bestName.toUpperCase();
                                        }
                                        return bestName || 'CURRENT TEACHER';
                                    })(),
                                    teacherId: record.teacherId || '-',
                                    present: 0,
                                    absent: 0,
                                    total: 0,
                                    dates: {}
                                };
                                console.log('Added student-subject:', {
                                    name: studentAttendance[studentSubjectKey].name,
                                    subject: record.subject,
                                    department: studentDepartmentCode,
                                    year: studentYear,
                                    division: studentDivision
                                });
                            }
                        }
                    });
                }
            });

            console.log('Filtering summary:', {
                totalStudents,
                filteredStudents,
                filters
            });

            // Process attendance records for found students
            Object.entries(attendanceData).forEach(([key, record]) => {
                if (!record.date || !record.students) {
                    return;
                }

                // Apply subject filter if specified
                if (filters.subject && record.subject && 
                    !record.subject.toLowerCase().includes(filters.subject.toLowerCase())) {
                    return;
                }

                const recordDate = new Date(record.date);
                const start = filters.startDate ? new Date(filters.startDate) : null;
                const end = filters.endDate ? new Date(filters.endDate) : null;

                if ((!start || recordDate >= start) && (!end || recordDate <= end)) {
                    Object.entries(record.students).forEach(([studentId, status]) => {
                        const studentSubjectKey = `${studentId}_${record.subject || 'unknown'}`;
                        if (studentAttendance[studentSubjectKey]) {
                            studentAttendance[studentSubjectKey].total++;
                            
                            // Enhanced status checking to handle all possible formats
                            // Debug: Log status values to identify patterns
                            if (Math.random() < 0.01) { // Log 1% of records to avoid spam
                                console.log('Attendance status debug:', {
                                    studentId,
                                    status,
                                    statusType: typeof status,
                                    statusValue: JSON.stringify(status),
                                    date: record.date,
                                    subject: record.subject
                                });
                            }
                            
                            // Handle null/undefined values
                            if (status === null || status === undefined) {
                                console.warn('Null/undefined attendance status found:', {
                                    studentId,
                                    date: record.date,
                                    subject: record.subject
                                });
                                // Skip this record or treat as absent
                                studentAttendance[studentSubjectKey].absent++;
                                studentAttendance[studentSubjectKey].dates[record.date] = 'absent';
                                return;
                            }
                            
                            const isPresent = (
                                status === true || 
                                status === 'true' ||
                                status === 'present' || 
                                status === 'Present' || 
                                status === 'PRESENT' ||
                                status === 'P' ||
                                status === 'p' ||
                                status === 1 ||
                                status === '1' ||
                                (typeof status === 'string' && status.toLowerCase().trim() === 'present')
                            );
                            
                            if (isPresent) {
                                studentAttendance[studentSubjectKey].present++;
                            } else {
                                studentAttendance[studentSubjectKey].absent++;
                            }
                            
                            studentAttendance[studentSubjectKey].dates[record.date] = status;
                            // Subject is already set during initialization
                        }
                    });
                }
            });

            // Convert to array and calculate percentages
            let students = Object.values(studentAttendance).map(student => {
                const percentage = student.total > 0 ? ((student.present / student.total) * 100) : 0;
                return {
                    ...student,
                    percentage
                };
            });
            
            // Debug: Log attendance summary
            console.log('Attendance processing summary:', {
                totalStudentRecords: students.length,
                studentsWithAttendance: students.filter(s => s.total > 0).length,
                studentsWithoutAttendance: students.filter(s => s.total === 0).length,
                totalPresentRecords: students.reduce((sum, s) => sum + s.present, 0),
                totalAbsentRecords: students.reduce((sum, s) => sum + s.absent, 0),
                totalRecords: students.reduce((sum, s) => sum + s.total, 0),
                sampleStudents: students.slice(0, 3).map(s => ({
                    name: s.name,
                    present: s.present,
                    absent: s.absent,
                    total: s.total,
                    percentage: s.percentage.toFixed(1)
                }))
            });

            // Apply percentage filter if selected
            const percentageFilter = document.getElementById('percentageFilter').value;
            const customPercentage = document.getElementById('customPercentage').value;
            const filterPercentage = percentageFilter === 'custom' ? parseFloat(customPercentage) : parseFloat(percentageFilter);

            if (filterPercentage) {
                students = students.filter(student => student.percentage < filterPercentage);
            }

            console.log('Final filtered students:', {
                total: students.length,
                byDepartment: students.reduce((acc, s) => {
                    acc[s.department] = (acc[s.department] || 0) + 1;
                    return acc;
                }, {}),
                byYear: students.reduce((acc, s) => {
                    acc[s.year] = (acc[s.year] || 0) + 1;
                    return acc;
                }, {}),
                byDivision: students.reduce((acc, s) => {
                    acc[s.division] = (acc[s.division] || 0) + 1;
                    return acc;
                }, {})
            });
            
            return students;
        }

        // Helper functions for department and year code conversion
        function getDepartmentCode(department) {
            if (!department) return '-';
            const dept = department.toString().toUpperCase();
            switch (dept) {
                case 'COMPUTER TECHNOLOGY':
                case 'COMPUTER':
                case 'COMP':
                    return 'CT';
                case 'INFORMATION TECHNOLOGY':
                case 'IT':
                    return 'IT';
                case 'MECHANICAL ENGINEERING':
                case 'MECHANICAL':
                case 'MECH':
                    return 'ME';
                case 'CIVIL ENGINEERING':
                case 'CIVIL':
                    return 'CE';
                case 'ELECTRICAL ENGINEERING':
                case 'ELECTRICAL':
                case 'EE':
                    return 'EE';
                case 'ELECTRONICS & TELECOMMUNICATION':
                case 'ELECTRONICS AND TELECOMMUNICATION':
                case 'ENTC':
                case 'ET':
                    return 'ET';
                case 'ARTIFICIAL INTELLIGENCE':
                case 'AI':
                    return 'AI';
                default:
                    return dept.length <= 3 ? dept : dept.substring(0, 3);
            }
        }

        function getDepartmentFullName(code) {
            if (!code) return '-';
            switch (code.toUpperCase()) {
                case 'CT': return 'Computer Technology';
                case 'IT': return 'Information Technology';
                case 'ME': return 'Mechanical Engineering';
                case 'CE': return 'Civil Engineering';
                case 'EE': return 'Electrical Engineering';
                case 'ET': return 'Electronics & Telecommunication';
                case 'AI': return 'Artificial Intelligence';
                default: return code;
            }
        }

        function getYearCode(year) {
            if (!year) return '-';
            const yr = year.toString().toUpperCase();
            switch (yr) {
                case 'FIRST YEAR':
                case 'FIRST':
                case '1':
                case 'I':
                    return 'FY';
                case 'SECOND YEAR':
                case 'SECOND':
                case '2':
                case 'II':
                    return 'SY';
                case 'THIRD YEAR':
                case 'THIRD':
                case '3':
                case 'III':
                    return 'TY';
                case 'FINAL YEAR':
                case 'FOURTH YEAR':
                case 'FOURTH':
                case 'FINAL':
                case '4':
                case 'IV':
                    return 'BE';
                default:
                    return yr.length <= 3 ? yr : yr.substring(0, 3);
            }
        }

        function showLoadingState() {
            // Show loading state in table
            const tableBody = document.getElementById('attendanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center p-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading attendance records...</p>
                        </td>
                    </tr>
                `;
            }
        }

        function showError(error) {
            const tableBody = document.getElementById('attendanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                        <tr>
                        <td colspan="11" class="text-center p-4">
                            <i class="fas fa-exclamation-circle text-danger fa-2x mb-3"></i>
                            <p>Error loading attendance data</p>
                            <p class="text-muted small">${error.message}</p>
                            </td>
                        </tr>
                    `;
            }
        }

        // Add these new functions for selection handling
        let selectedStudents = new Set();

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedStudents.add(checkbox.value);
                } else {
                    selectedStudents.delete(checkbox.value);
                }
            });
            
            updateDeleteButton();
        }

        function toggleStudent(studentId, checked) {
            if (checked) {
                selectedStudents.add(studentId);
            } else {
                selectedStudents.delete(studentId);
            }
            
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.student-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            selectAllCheckbox.checked = selectedStudents.size === allCheckboxes.length;
            
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const deleteBtn = document.querySelector('button[onclick="confirmDeleteAllAttendance()"]');
            if (selectedStudents.size > 0) {
                deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedStudents.size})`;
            } else {
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete All Attendance';
            }
        }

        // Update the updateTable function to include checkboxes
        function updateTable(students) {
            const tableBody = document.getElementById('attendanceTableBody');
            if (!tableBody) return;

            // Store current data for export functions
            currentFilteredStudents = students;

            if (students.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center" style="padding: 40px;">
                            <i class="fas fa-folder-open" style="font-size: 48px; color: #9CA3AF; margin-bottom: 16px;"></i>
                            <p style="color: #4B5563; font-size: 1.1rem; font-weight: 500;">No attendance records found</p>
                            <p style="color: #6B7280; font-size: 0.95rem;">Try changing the filters or selecting a different date range</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort students by roll number
            students.sort((a, b) => {
                // Extract numeric and non-numeric parts
                const splitRoll = roll => {
                    const match = (roll || '').match(/^([A-Za-z]*)(\d*)/);
                    return match ? [match[1].toLowerCase(), parseInt(match[2]) || 0] : ['', 0];
                };
                
                const [prefixA, numA] = splitRoll(a.rollNo);
                const [prefixB, numB] = splitRoll(b.rollNo);
                
                // First compare prefixes
                if (prefixA !== prefixB) {
                    return prefixA.localeCompare(prefixB);
                }
                
                // Then compare numbers
                return numA - numB;
            });

            console.log('Updating table with students:', students.map(s => ({
                name: s.name,
                rollNo: s.rollNo,
                teacherName: s.teacherName
            })));

            tableBody.innerHTML = students.map(student => {
                const percentage = student.total > 0 
                    ? ((student.present / student.total) * 100).toFixed(1) 
                    : '0.0';
                
                let statusClass = 'good';
                let statusText = 'Good';
                
                if (percentage < 50) {
                    statusClass = 'critical';
                    statusText = 'Critical';
                } else if (percentage < 75) {
                    statusClass = 'low';
                    statusText = 'Warning';
                }

                // Calculate total lectures and attendance stats
                const totalLectures = student.present + student.absent;
                const presentPercentage = ((student.present / totalLectures) * 100).toFixed(1);
                const absentPercentage = ((student.absent / totalLectures) * 100).toFixed(1);

                return `
                    <tr>
                        <td>
                            <input type="checkbox" 
                                class="student-checkbox" 
                                value="${student.id}"
                                ${selectedStudents.has(student.id) ? 'checked' : ''}
                                onchange="toggleStudent('${student.id}', this.checked)">
                        </td>
                        <td>${student.rollNo || '-'}</td>
                        <td>${student.name || '-'}</td>
                        <td>${student.departmentName || getDepartmentFullName(student.department) || '-'}</td>
                        <td>${student.year || '-'}</td>
                        <td>${student.division || '-'}</td>
                        <td>${student.subject || '-'}</td>
                        <td><span style="background: ${student.lectureType === 'practical' ? '#e3f2fd' : '#f3e5f5'}; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; color: ${student.lectureType === 'practical' ? '#1565c0' : '#7b1fa2'};">${student.lectureType || 'Theory'}</span></td>
                        <td>
                            <span class="attendance-count present" title="${presentPercentage}% Present">
                                <i class="fas fa-check"></i>
                                ${student.present}/${totalLectures}
                                <small style="color: #047857">(${presentPercentage}%)</small>
                            </span>
                        </td>
                        <td>
                            <span class="attendance-count absent" title="${absentPercentage}% Absent">
                                <i class="fas fa-times"></i>
                                ${student.absent}/${totalLectures}
                                <small style="color: #DC2626">(${absentPercentage}%)</small>
                            </span>
                        </td>
                        <td class="attendance-percentage">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="font-size: 1.1em; font-weight: bold;">${percentage}%</div>
                                <div style="font-size: 0.9em; color: #666;">
                                    ${student.present}/${totalLectures} lectures
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i class="fas ${percentage >= 75 ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editStudent('${student.id}')" title="Edit Student">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Store current filtered data for export functions
        let currentFilteredStudents = [];

        function getCurrentFilteredData() {
            return currentFilteredStudents;
        }

        function exportToExcel() {
            const students = getCurrentFilteredData();
            if (!students || students.length === 0) {
                alert('No data to export');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for export
            const exportData = students.map(student => ({
                'Roll No': student.rollNo,
                'Name': student.name,
                'Department': student.department,
                'Year': student.year,
                'Division': student.division,
                'Subject': student.subject,
                'Teacher': student.teacherName,
                'Present': student.present,
                'Absent': student.absent,
                'Total': student.total,
                'Attendance %': student.percentage.toFixed(1) + '%'
            }));

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Add worksheet to workbook
            const filterValue = document.getElementById('percentageFilter').value;
            const filterText = filterValue === 'custom' 
                ? document.getElementById('customPercentage').value 
                : filterValue;
            const sheetName = filterValue 
                ? `Below ${filterText}% Attendance` 
                : 'All Students';
            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Generate Excel file
            const date = new Date().toLocaleDateString().replace(/\//g, '-');
            XLSX.writeFile(wb, `Attendance_Report_${date}.xlsx`);
        }

        // PDF export function removed as per user request
        // function exportToPDF() { ... }

        function getCurrentFilteredData() {
            // Get the current filtered data from the table
            const tableBody = document.getElementById('attendanceTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            const students = [];
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 0) continue; // Skip if no cells (like in loading/error state)
                
                // Get text content of cells
                const rollNo = cells[1].textContent.trim();
                const name = cells[2].textContent.trim();
                const department = cells[3].textContent.trim();
                const year = cells[4].textContent.trim();
                const division = cells[5].textContent.trim();
                const subject = cells[6].textContent.trim();
                const teacherName = cells[7].textContent.trim();
                const present = parseInt(cells[8].textContent.match(/\d+/)[0]);
                const absent = parseInt(cells[9].textContent.match(/\d+/)[0]);
                const percentage = parseFloat(cells[10].textContent);
                
                students.push({
                    id: cells[0].querySelector('.student-checkbox').value, // Use the checkbox value as the ID
                    rollNo,
                    name,
                    department,
                    year,
                    division,
                    subject,
                    teacherName,
                    present,
                    absent,
                    total: present + absent,
                    percentage
                });
            }
            
            return students;
        }

        // Add event listener for subject filter
        document.addEventListener('DOMContentLoaded', () => {
            // Add existing event listeners
            document.getElementById('department').addEventListener('change', loadReports);
            document.getElementById('year').addEventListener('change', loadReports);
            document.getElementById('division').addEventListener('change', loadReports);
            document.getElementById('startDate').addEventListener('change', loadReports);
            document.getElementById('endDate').addEventListener('change', loadReports);
            document.getElementById('percentageFilter').addEventListener('change', loadReports);
            document.getElementById('customPercentage').addEventListener('input', loadReports);
            
            // Add new subject filter event listener
            document.getElementById('subject').addEventListener('input', debounce(loadReports, 500));
        });

        // Add debounce function to prevent too many API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to show delete confirmation modal
        function confirmDeleteAllAttendance() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'block';
        }

        // Function to close delete confirmation modal
        function closeDeleteModal() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'none';
        }

        // Function to delete all attendance records
        async function deleteAllAttendance() {
            try {
                console.log('Starting delete operation...');
                
                // Check if user is admin
                const isAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
                console.log('Is admin?', isAdmin);
                
                if (!isAdmin) {
                    alert('Only administrators can delete attendance records.');
                    closeDeleteModal();
                    return;
                }

                // Show loading state
                const deleteBtn = document.querySelector('.modal-footer .btn-danger');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteBtn.disabled = true;

                // Get attendance records
                const snapshot = await window.db.ref('attendance').once('value');
                const attendanceData = snapshot.val() || {};

                try {
                    // If specific students are selected
                    if (selectedStudents.size > 0) {
                        console.log('Deleting attendance for selected students:', selectedStudents);
                        
                        // Create updates object
                        const updates = {};
                        
                        // For each attendance record
                        Object.entries(attendanceData).forEach(([key, record]) => {
                            if (record.students) {
                                // Keep only non-selected students
                                const updatedStudents = {};
                                Object.entries(record.students).forEach(([studentId, status]) => {
                                    if (!selectedStudents.has(studentId)) {
                                        updatedStudents[studentId] = status;
                                    }
                                });
                                
                                if (Object.keys(updatedStudents).length > 0) {
                                    // Update record with remaining students
                                    updates[`attendance/${key}/students`] = updatedStudents;
                                } else {
                                    // If no students left, delete the entire record
                                    updates[`attendance/${key}`] = null;
                                }
                            }
                        });
                        
                        // Apply updates
                        await window.db.ref().update(updates);
                        console.log('Selected students attendance deleted');
                        
                    } else {
                        // Delete all attendance records
                        await window.db.ref('attendance').remove();
                        console.log('All attendance records deleted');
                    }

                    // Clear selected students
                    selectedStudents.clear();
                    
                    // Close modal
                    closeDeleteModal();

                    // Show success message
                    alert('Selected attendance records have been deleted successfully.');

                    // Clear the table immediately
                    const tableBody = document.getElementById('attendanceTableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center" style="padding: 40px;">
                                <i class="fas fa-folder-open" style="font-size: 48px; color: #9CA3AF; margin-bottom: 16px;"></i>
                                <p style="color: #4B5563; font-size: 1.1rem; font-weight: 500;">No attendance records found</p>
                                <p style="color: #6B7280; font-size: 0.95rem;">All selected records have been deleted</p>
                            </td>
                        </tr>
                    `;

                    // Force reload data from server
                    await window.db.ref('attendance').once('value', null, { serverCache: true });
                    
                    // Reload reports with cache disabled
                    await loadReports();

                    // Refresh the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);

                } catch (error) {
                    console.error('Error in delete operation:', error);
                    alert('Error deleting records: ' + error.message);
                }

            } catch (error) {
                console.error('Error in deleteAllAttendance:', error);
                alert('Error deleting attendance records: ' + error.message);
            } finally {
                // Reset button state
                const deleteBtn = document.querySelector('.modal-footer .btn-danger');
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('deleteConfirmModal');
            if (event.target == modal) {
                closeDeleteModal();
            }
        };

        // Initialize teacher UID to code mapping
        (async function() {
            try {
                // Wait for Firebase to be ready
                if (typeof window.waitForFirebase === 'function') {
                    await window.waitForFirebase();
                }
                
                // Check if db is available
                if (window.db && typeof window.db.ref === 'function') {
                    const teacherUidToCodeSnap = await window.db.ref('teacherUidToCode').once('value');
                    window.teacherUidToCode = teacherUidToCodeSnap.exists() ? teacherUidToCodeSnap.val() : {};
                    console.log('Teacher UID to Code mapping loaded:', Object.keys(window.teacherUidToCode).length, 'entries');
                    console.log('Sample mapping entries:', Object.entries(window.teacherUidToCode).slice(0, 3));
                } else {
                    console.warn('Firebase database not available, using empty teacher UID mapping');
                    window.teacherUidToCode = {};
                }
            } catch (error) {
                console.error('Error loading teacher UID to code mapping:', error);
                window.teacherUidToCode = {};
            }
        })();

        // Function to edit student attendance - Simple version
        function editStudent(studentId) {
            console.log('Edit button clicked for student ID:', studentId);
            console.log('Current filtered students:', currentFilteredStudents);
            
            // Find the student data from current filtered students
            let student = currentFilteredStudents.find(s => s.id === studentId);
            
            // If not found by id, try to find by other fields
            if (!student) {
                student = currentFilteredStudents.find(s => 
                    s.rollNo === studentId || 
                    s.name === studentId ||
                    JSON.stringify(s).includes(studentId)
                );
            }
            
            if (!student) {
                alert('Student not found. ID: ' + studentId);
                console.error('Student not found with ID:', studentId);
                return;
            }

            console.log('Found student:', student);

            // Simple prompt to change present/absent counts
            const currentPresent = student.present || 0;
            const currentAbsent = student.absent || 0;
            const total = currentPresent + currentAbsent;
            
            if (total === 0) {
                alert('This student has no attendance records to edit.');
                return;
            }
            
            const newPresent = prompt(`Student: ${student.name} (${student.rollNo})\n\nCurrent: ${currentPresent} Present, ${currentAbsent} Absent\nTotal Lectures: ${total}\n\nEnter new Present count (0-${total}):`, currentPresent);
            
            if (newPresent === null) return; // User cancelled
            
            const presentCount = parseInt(newPresent);
            if (isNaN(presentCount) || presentCount < 0 || presentCount > total) {
                alert('Invalid number. Please enter a number between 0 and ' + total);
                return;
            }
            
            const absentCount = total - presentCount;
            
            // Update the student data
            updateStudentAttendance(student, presentCount, absentCount);
        }

        // Function to update student attendance - Simple version
        async function updateStudentAttendance(student, newPresent, newAbsent) {
            try {
                console.log('Updating attendance for student:', student);
                console.log('New values - Present:', newPresent, 'Absent:', newAbsent);
                
                // Wait for Firebase to be ready
                await waitForFirebase();
                
                // Try to update the student data directly in the processed data structure
                // This is a simpler approach that works with the current data
                
                // Update the student object in currentFilteredStudents immediately
                const studentIndex = currentFilteredStudents.findIndex(s => 
                    s.rollNo === student.rollNo && s.name === student.name
                );
                
                if (studentIndex !== -1) {
                    currentFilteredStudents[studentIndex].present = newPresent;
                    currentFilteredStudents[studentIndex].absent = newAbsent;
                    currentFilteredStudents[studentIndex].total = newPresent + newAbsent;
                    
                    console.log('Updated student data:', currentFilteredStudents[studentIndex]);
                    
                    // Immediately update the table display
                    updateTable(currentFilteredStudents);
                    
                    console.log('Table updated with new data');
                } else {
                    console.log('Student not found in currentFilteredStudents for immediate update');
                }
                
                // Also try to find and update in Firebase
                const attendanceRef = window.firebase.database().ref('attendance');
                const snapshot = await attendanceRef.once('value');
                const allAttendance = snapshot.val() || {};
                
                console.log('Searching in', Object.keys(allAttendance).length, 'attendance records');
                
                // Find matching records (there might be multiple)
                const matchingKeys = [];
                Object.keys(allAttendance).forEach(key => {
                    const record = allAttendance[key];
                    if (record.rollNo === student.rollNo || 
                        (record.name === student.name && record.department === student.department)) {
                        matchingKeys.push(key);
                        console.log('Found matching record:', key, record);
                    }
                });
                
                if (matchingKeys.length > 0) {
                    // Update all matching records
                    const updates = {};
                    matchingKeys.forEach(key => {
                        updates[`attendance/${key}/present`] = newPresent;
                        updates[`attendance/${key}/absent`] = newAbsent;
                        updates[`attendance/${key}/total`] = newPresent + newAbsent;
                        updates[`attendance/${key}/lastModified`] = new Date().toISOString();
                    });
                    
                    await window.firebase.database().ref().update(updates);
                    console.log('Updated', matchingKeys.length, 'records in Firebase');
                } else {
                    console.log('No matching records found in Firebase, creating new record');
                    // Create new record
                    await attendanceRef.push({
                        rollNo: student.rollNo,
                        name: student.name,
                        department: student.department || student.departmentName,
                        year: student.year,
                        division: student.division,
                        present: newPresent,
                        absent: newAbsent,
                        total: newPresent + newAbsent,
                        lastModified: new Date().toISOString(),
                        createdBy: 'edit_function'
                    });
                }
                
                alert(`Attendance updated successfully!\n\nStudent: ${student.name}\nNew Present: ${newPresent}\nNew Absent: ${newAbsent}\n\nTable has been updated with new values.`);
                
                // Table is already updated immediately above, no need to reload
                
            } catch (error) {
                console.error('Error updating attendance:', error);
                alert('Error updating attendance: ' + error.message);
            }
        }

        // Simple edit functionality complete - no complex functions needed
    </script>

    <!-- Add required libraries for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
</body>
</html> 